<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torre de Controle - Gil Eventos</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #121212; color: #fff; margin: 0; padding: 20px; overflow-x: hidden; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        h1 { margin: 0; color: #FFD580; font-size: 1.5em; }
        .badge-event { background: #333; padding: 5px 10px; border-radius: 4px; font-size: 0.8em; margin-left: 10px; vertical-align: middle; }
        .grid-layout { display: grid; grid-template-columns: 300px 1fr 300px; gap: 20px; height: calc(100vh - 100px); }
        .col-commands { display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .col-queue { background: #181818; border-radius: 12px; padding: 15px; border: 1px solid #333; display: flex; flex-direction: column; }
        .col-history { background: #151515; border-radius: 12px; padding: 15px; overflow-y: auto; border: 1px solid #222; }
        .card-box { background: #1E1E1E; padding: 20px; border-radius: 12px; border: 1px solid #333; position: relative; }
        .eye-btn { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 1.2em; color: #888; background: none; border: none; }
        .big-stat { font-size: 2em; font-weight: 800; color: #4CAF50; }
        .label { color: #888; font-size: 0.8em; text-transform: uppercase; margin-bottom: 5px; }
        .btn-drink { width: 100%; padding: 12px; background: #333; border: 1px solid #555; color: #fff; margin-bottom: 8px; border-radius: 6px; cursor: pointer; text-align: left; transition: 0.2s; }
        .btn-drink:hover { background: #FFD580; color: #000; border-color: #FFD580; }
        .btn-drink.pausado { opacity: 0.5; text-decoration: line-through; border-color: red; }
        
        .order-card { background: #222; border-left: 5px solid #888; border-radius: 8px; padding: 15px; margin-bottom: 15px; animation: slideIn 0.3s; position: relative; }
        .order-card.extra { border-left-color: #FFD580; background: #2A2210; } 
        .order-card.pacote { border-left-color: #4CAF50; } 
        .order-card.pagamento { border-left-color: #FF4444; background: #2a1010; border: 1px dashed #FF4444; }
        .order-card.cliente-avisou { border: 2px solid #FFD580; box-shadow: 0 0 10px rgba(255, 213, 128, 0.3); }
        .order-info h3 { margin: 5px 0; font-size: 1.3em; }
        .client { color: #aaa; font-size: 0.9em; }
        .time { position: absolute; top: 10px; right: 10px; font-size: 0.8em; color: #666; font-family: monospace; }
        .actions { display: flex; gap: 5px; margin-top: 10px; }
        
        .btn-ok { flex: 2; background: #2E7D32; border: none; padding: 10px; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; }
        .btn-pay { flex: 2; background: #FFD580; border: none; padding: 10px; border-radius: 5px; color: #000; cursor: pointer; font-weight: bold; }
        .btn-deny { flex: 1; background: #D32F2F; border: none; padding: 10px; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; font-size: 0.8em; }
        .btn-cancel { flex: 1; background: transparent; border: 1px solid #777; padding: 10px; border-radius: 5px; color: #aaa; cursor: pointer; }
        .btn-prio { background: #2196F3; border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em; position: absolute; top: 10px; right: 60px; }
        
        .sound-control { display: flex; align-items: center; gap: 10px; background: #222; padding: 5px 15px; border-radius: 30px; border: 1px solid #444; }
        .stock-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #333; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4CAF50; }
        input:checked + .slider:before { transform: translateX(26px); }
        .obs-tag { background: #FFD580; color: black; padding: 2px 5px; border-radius: 4px; font-weight: bold; font-size: 0.8em; display: block; margin-top: 5px; }
        
        /* MODAIS */
        #loginOverlay, #eyeAuthOverlay, #qrOverlay, #stockOverlay, #contactsOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #eyeAuthOverlay, #qrOverlay, #stockOverlay, #contactsOverlay { display: none; }
        .login-box { text-align: center; background: #222; padding: 30px; border-radius: 15px; border: 1px solid #444; min-width: 300px; max-width: 500px; width:90%; }
        .btn-top { background: #444; color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-left: 5px; }
        .contacts-list { max-height: 300px; overflow-y: auto; text-align: left; margin-top: 15px; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .contact-row { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #333; font-size: 0.9em; }
        .contact-row span { color: #aaa; }
        .contact-row strong { color: #FFD580; }

        @media (max-width: 1000px) { .grid-layout { grid-template-columns: 1fr; height: auto; } .col-commands, .col-queue, .col-history { height: 500px; margin-bottom: 20px; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <audio id="somAlerta" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <div id="loginOverlay"><div class="login-box"><h1 style="margin-bottom:20px;">üîí √Årea Restrita</h1><input type="password" id="senhaInput" placeholder="Senha" style="padding:10px; border-radius:5px;"><br><br><button class="btn-top" style="background:#FFD580; color:black;" onclick="verificarSenha()">ACESSAR</button><p id="erroSenha" style="color:red; display:none; margin-top:10px;">Senha Incorreta!</p></div></div>
    <div id="stockOverlay"><div class="login-box" style="width: 400px; max-height: 80vh; overflow-y: auto;"><h2 style="color:#FFD580;">Gerenciar Card√°pio</h2><div id="listaEstoque"></div><button onclick="document.getElementById('stockOverlay').style.display='none'" class="btn-top" style="margin-top:20px; width:100%;">FECHAR</button></div></div>
    <div id="contactsOverlay"><div class="login-box"><h2 style="color:#FFD580;">üë• Leads</h2><div class="contacts-list" id="listaContatos">Carregando...</div><div style="margin-top:20px; display:flex; gap:10px; justify-content:center;"><button onclick="copiarListaContatos()" class="btn-top" style="background:#4CAF50;">üìã Copiar</button><button onclick="document.getElementById('contactsOverlay').style.display='none'" class="btn-top">Fechar</button></div></div></div>
    <div id="eyeAuthOverlay"><div class="login-box"><h3>üëÅÔ∏è Senha</h3><input type="password" id="senhaEyeInput"><br><br><button class="btn-top" onclick="confirmarSenhaEye()">VER</button><button onclick="document.getElementById('eyeAuthOverlay').style.display='none'" class="btn-top">Cancelar</button></div></div>
    <div id="qrOverlay"><div class="login-box"><h2 style="color:#FFD580;">üì≤ QR Code</h2><div id="qrcodeDisplay" style="background:white; padding:15px; border-radius:10px; display:inline-block; margin:20px 0;"></div><br><button onclick="document.getElementById('qrOverlay').style.display='none'" class="btn-top">Fechar</button></div></div>

    <div class="header">
        <div><span id="nomeEvento">Carregando...</span><span class="badge-event" id="tipoEvento">...</span> <button onclick="editarEvento()" class="btn-top" style="background:#333; border:1px solid #555; color:#aaa; font-size:0.8em;">‚úèÔ∏è Editar</button></div>
        <div class="sound-control"><span style="font-size:1.2em;">üîä</span><input type="range" min="0" max="1" step="0.1" value="1" onchange="document.getElementById('somAlerta').volume=this.value"></div>
        <div>
            <button onclick="abrirContatos()" class="btn-top" style="background:#9C27B0;">üë• Leads</button>
            <button onclick="toggleModoPreco()" class="btn-top" id="btnModoPreco" style="background:#555;">üí≤ Modo Normal</button>
            <button onclick="abrirEstoque()" class="btn-top" style="background:#2196F3;">üì¶ Estoque</button>
            <button onclick="mostrarQR()" class="btn-top">üì± QR</button>
            <button onclick="copiarLink()" class="btn-top">üîó Link</button>
        </div>
    </div>

    <div class="grid-layout">
        <div class="col-commands">
            <div class="card-box"><div class="label">Consumo Pacote</div><div class="big-stat"><span id="consumido">0</span> <span style="font-size:0.5em; color:#666;">/ <span id="total">‚àû</span></span></div><div style="height:5px; background:#333; margin-top:5px;"><div id="progressoBar" style="height:100%; width:0%; background:#4CAF50;"></div></div></div>
            <div class="card-box"><button class="eye-btn" onclick="toggleFaturamento()">üëÅÔ∏è</button><div class="label">Faturamento</div><div class="big-stat" style="color:#FFD580;"><span id="valorFaturamento" style="filter:blur(5px);">R$ 0,00</span></div><div style="font-size:0.8em; color:#666;">Vendas: <span id="qtdVendasExtras">0</span></div></div>
            <div class="card-box"><div class="label">üìù Pedido Manual</div><div id="listaBotoesManual" style="margin-top:10px;"></div></div>
        </div>
        <div class="col-queue"><div class="queue-header"><span>üî• Fila / Caixa</span><span style="font-size:0.8em; background:#FF4444; padding:2px 8px; border-radius:10px; color:white;" id="qtdFila">0</span></div><div class="queue-list" id="listaFila"></div></div>
        <div class="col-history"><div class="queue-header">üìú Hist√≥rico</div><div id="listaHistorico"></div></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDLPi5Mf6_9ypigmf3v9Qe9YYPUr1mfaHk",
            authDomain: "gil-eventos-app-911fe.firebaseapp.com",
            projectId: "gil-eventos-app-911fe",
            storageBucket: "gil-eventos-app-911fe.firebasestorage.app",
            messagingSenderId: "503025880352",
            appId: "1:503025880352:web:694b7f2889cff501c7db45",
            measurementId: "G-3DZ1P5C0M3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const params = new URLSearchParams(window.location.search);
        const EVENTO_ID = params.get('evento');
        let DADOS_EVENTO = null;
        let FATURAMENTO_VISIVEL = false;
        let wakeLock = null;

        if(sessionStorage.getItem(`logado_${EVENTO_ID}`)) document.getElementById('loginOverlay').style.display = 'none';
        if(EVENTO_ID) iniciarTorreControle();

        async function requestWakeLock() { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }
        document.addEventListener('visibilitychange', async () => { if (wakeLock !== null && document.visibilityState === 'visible') requestWakeLock(); });

        function iniciarTorreControle() {
            requestWakeLock();
            db.collection("eventos").doc(EVENTO_ID).onSnapshot((doc) => {
                if(doc.exists){ 
                    DADOS_EVENTO = doc.data(); 
                    atualizarInterface(DADOS_EVENTO); 
                    gerarBotoes(DADOS_EVENTO.cardapio);
                    gerarListaEstoque(DADOS_EVENTO.cardapio);
                }
            });
            // SEM ORDERBY para evitar erro de √≠ndice
            db.collection("pedidos").where("evento_id", "==", EVENTO_ID).where("status", "in", ["pendente", "aguardando_pagamento", "pagamento_rejeitado"]).onSnapshot((snapshot) => {
                const lista = document.getElementById('listaFila');
                document.getElementById('qtdFila').innerText = snapshot.size;
                snapshot.docChanges().forEach((change) => { if (change.type === "added") document.getElementById('somAlerta').play().catch(()=>{}); });
                lista.innerHTML = snapshot.empty ? '<div style="text-align:center; color:#555; margin-top:50px;">Vazio</div>' : '';
                
                // ORDENA√á√ÉO MANUAL JS
                let pedidos = [];
                snapshot.forEach(doc => pedidos.push({id: doc.id, ...doc.data()}));
                pedidos.sort((a, b) => {
                    const prioA = a.prioridade || 0; const prioB = b.prioridade || 0;
                    if (prioB !== prioA) return prioB - prioA;
                    return a.data - b.data;
                });

                pedidos.forEach(p => {
                    const hora = p.data.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    let classe, badge, btnHtml;
                    let visualAviso = p.sinalizou_pagamento ? 'cliente-avisou' : '';
                    let obsHtml = p.observacao ? `<span class="obs-tag">‚ö†Ô∏è OBS: ${p.observacao}</span>` : '';
                    let prioridadeClass = (p.prioridade || 0) > 0 ? 'prioridade-alta' : '';

                    if(p.status === 'aguardando_pagamento' || p.status === 'pagamento_rejeitado') {
                        classe = 'pagamento';
                        badge = `üî¥ AGUARDANDO PGTO (R$ ${p.preco}) ${p.sinalizou_pagamento ? 'üëâ CLIENTE PAGOU' : ''}`;
                        // BOT√ïES PARA PAGAMENTO - COM CONFIRM
                        btnHtml = `
                            <button class="btn-deny" onclick="recusarPagamento('${p.id}')">üö´ N√ÉO CONSTA</button>
                            <button class="btn-pay" onclick="confirmarPagamento('${p.id}', ${p.preco})">üí∞ CONFIRMAR</button>
                        `;
                    } else {
                        classe = p.tipo === 'extra' ? 'extra' : 'pacote';
                        badge = p.tipo === 'extra' ? 'üí≤ PAGO' : 'üÜì PACOTE';
                        // BOT√ÉO PRONTO - COM CONFIRM
                        btnHtml = `<button class="btn-ok" onclick="mudarStatus('${p.id}', 'servido', '${p.tipo}')">‚úÖ PRONTO</button>`;
                    }

                    lista.innerHTML += `
                    <div class="order-card ${classe} ${visualAviso} ${prioridadeClass}">
                        <div class="time">${hora}</div>
                        <button class="btn-prio" onclick="priorizarPedido('${p.id}')">‚¨ÜÔ∏è</button>
                        <div class="client">${p.nome_convidado}</div>
                        <div class="order-info"><h3>${p.drink}</h3><small style="background:rgba(0,0,0,0.3); padding:2px 5px; border-radius:3px;">${badge}</small>${obsHtml}</div>
                        <div class="actions">
                            <button class="btn-cancel" onclick="cancelarPedido('${p.id}')">‚úñ</button>
                            ${btnHtml}
                        </div>
                    </div>`;
                });
            });
            db.collection("pedidos").where("evento_id", "==", EVENTO_ID).where("status", "in", ["servido", "cancelado"]).limit(30).onSnapshot((s) => { 
                const l = document.getElementById('listaHistorico'); l.innerHTML = ''; 
                s.forEach(doc => { const p = doc.data(); l.innerHTML += `<div class="hist-item"><div><strong style="color:#FFD580">${p.drink}</strong><br><span style="color:#666">${p.nome_convidado}</span></div><div style="text-align:right">${p.status}</div></div>`; }); 
            });
        }

        // --- FUN√á√ïES DE CONTATOS (LEADS) ---
        function abrirContatos() {
            document.getElementById('contactsOverlay').style.display = 'flex';
            const lista = document.getElementById('listaContatos');
            lista.innerHTML = "Carregando...";
            db.collection("clientes_marketing").where("evento_id", "==", EVENTO_ID).get().then((q) => {
                if (q.empty) { lista.innerHTML = "<p style='color:#777; padding:10px;'>Nenhum contato salvo ainda.</p>"; return; }
                lista.innerHTML = "";
                q.forEach((doc) => {
                    const d = doc.data();
                    let dataStr = d.data_cadastro && d.data_cadastro.toDate ? d.data_cadastro.toDate().toLocaleDateString() : "";
                    lista.innerHTML += `<div class="contact-row"><div><strong>${d.nome}</strong></div><div>${d.whatsapp}</div><div style="font-size:0.8em;">${dataStr}</div></div>`;
                });
            }).catch(e => { console.log(e); lista.innerHTML = "Erro ao carregar."; });
        }
        function copiarListaContatos() {
            let texto = "NOME; WHATSAPP\n";
            document.querySelectorAll('.contact-row').forEach(row => { texto += `${row.children[0].innerText}; ${row.children[1].innerText}\n`; });
            navigator.clipboard.writeText(texto).then(() => alert("Copiado!"));
        }

        // --- A√á√ïES DO ADMIN COM CONFIRMA√á√ÉO ---
        function priorizarPedido(id) { db.collection("pedidos").doc(id).update({ prioridade: 1 }); }
        
        function confirmarPagamento(id, preco) { 
            if(!confirm("Dinheiro confirmado no PIX?")) return; 
            db.collection("pedidos").doc(id).update({ status: 'pendente', sinalizou_pagamento: false }); 
            db.collection("eventos").doc(EVENTO_ID).update({ total_vendas_extra: firebase.firestore.FieldValue.increment(1), total_faturamento: firebase.firestore.FieldValue.increment(preco) }); 
        }
        
        function recusarPagamento(id) { 
            if(!confirm("Tem certeza que o pagamento N√ÉO chegou?")) return; 
            db.collection("pedidos").doc(id).update({ status: 'pagamento_rejeitado', sinalizou_pagamento: false }); 
        }
        
        function mudarStatus(id, novoStatus, tipo) { 
            if(!confirm("Confirmar entrega do drink?")) return; 
            db.collection("pedidos").doc(id).update({ status: novoStatus }); 
            if(novoStatus === 'servido' && tipo === 'pacote') { 
                db.collection("eventos").doc(EVENTO_ID).update({ total_consumido: firebase.firestore.FieldValue.increment(1) }); 
            } 
        }
        
        function cancelarPedido(id) { 
            if(!confirm("Cancelar este pedido?")) return; 
            db.collection("pedidos").doc(id).update({ status: 'cancelado' }); 
        }
        
        function lancarManual(item) { const nome = prompt(`Nome do cliente para ${item.nome}:`, "Balc√£o"); if(nome === null) return; let tipo = 'pacote'; if(item.tipo_cobranca === 'pago' || (DADOS_EVENTO.tipo_servico==='pacote' && DADOS_EVENTO.total_consumido >= DADOS_EVENTO.total_contratado)) tipo='extra'; db.collection("pedidos").add({ evento_id: EVENTO_ID, drink: item.nome, tipo: tipo, preco: item.preco||0, nome_convidado: nome || "Balc√£o", status: 'pendente', prioridade: 0, data: new Date() }); }
        function gerarBotoes(menu) { const div = document.getElementById('listaBotoesManual'); div.innerHTML = ''; menu.forEach(item => { const btn = document.createElement('button'); const pausado = item.disponivel === false; btn.className = item.is_premium ? 'btn-drink premium' : 'btn-drink'; if(pausado) btn.classList.add('pausado'); btn.innerText = (item.is_premium?'üí≤ ':'üÜì ') + item.nome + (pausado ? ' (PAUSADO)' : ''); btn.onclick = () => { if(!pausado) lancarManual(item); else alert("Drink pausado."); }; div.appendChild(btn); }); }
        function abrirEstoque() { document.getElementById('stockOverlay').style.display = 'flex'; }
        function gerarListaEstoque(menu) { const div = document.getElementById('listaEstoque'); div.innerHTML = ''; menu.forEach((item, index) => { const checked = item.disponivel !== false ? 'checked' : ''; div.innerHTML += `<div class="stock-item"><span>${item.nome}</span><label class="toggle-switch"><input type="checkbox" ${checked} onchange="toggleDisponibilidade(${index})"><span class="slider"></span></label></div>`; }); }
        function toggleDisponibilidade(index) { let cardapio = DADOS_EVENTO.cardapio; cardapio[index].disponivel = !(cardapio[index].disponivel !== false); db.collection("eventos").doc(EVENTO_ID).update({ cardapio: cardapio }); }
        function toggleModoPreco() { const novo = DADOS_EVENTO.modo_preco === 'prevenda' ? 'normal' : 'prevenda'; db.collection("eventos").doc(EVENTO_ID).update({ modo_preco: novo }); }
        function editarEvento() { window.location.href = window.location.href.replace('dashboard.html', 'admin.html'); }
        function verificarSenha() { if(document.getElementById('senhaInput').value === DADOS_EVENTO.senha_admin) { document.getElementById('loginOverlay').style.display = 'none'; sessionStorage.setItem(`logado_${EVENTO_ID}`, true); document.getElementById('somAlerta').play().catch(()=>{}); } else document.getElementById('erroSenha').style.display='block'; }
        function toggleFaturamento() { const el=document.getElementById('valorFaturamento'); if(FATURAMENTO_VISIVEL){el.style.filter='blur(5px)';FATURAMENTO_VISIVEL=false;}else{document.getElementById('eyeAuthOverlay').style.display='flex';document.getElementById('senhaEyeInput').focus();} }
        function confirmarSenhaEye() { if(document.getElementById('senhaEyeInput').value===DADOS_EVENTO.senha_admin){document.getElementById('eyeAuthOverlay').style.display='none';document.getElementById('valorFaturamento').style.filter='none';FATURAMENTO_VISIVEL=true;}else alert("Senha errada"); }
        function mostrarQR() { const url=window.location.href.replace('dashboard.html','index.html'); document.getElementById('qrcodeDisplay').innerHTML=''; new QRCode(document.getElementById("qrcodeDisplay"),{text:url,width:250,height:250}); document.getElementById('qrOverlay').style.display='flex'; }
        function copiarLink() { navigator.clipboard.writeText(window.location.href.replace('dashboard.html','index.html')); alert("Copiado!"); }
        function atualizarInterface(dados) { document.getElementById('nomeEvento').innerText = dados.nome; document.getElementById('consumido').innerText = dados.total_consumido; if(dados.tipo_servico === 'pacote') { document.getElementById('total').innerText = dados.total_contratado; document.getElementById('progressoBar').style.width = ((dados.total_consumido/dados.total_contratado)*100)+'%'; } document.getElementById('valorFaturamento').innerText = `R$ ${dados.total_faturamento.toFixed(2)}`; document.getElementById('qtdVendasExtras').innerText = dados.total_vendas_extra; const btnModo = document.getElementById('btnModoPreco'); if(dados.modo_preco === 'prevenda') { btnModo.innerText = "üü£ Pr√©-Venda"; btnModo.style.background = "#9C27B0"; } else { btnModo.innerText = "üí≤ Normal (Dia)"; btnModo.style.background = "#555"; } }
    </script>
</body>
</html>
