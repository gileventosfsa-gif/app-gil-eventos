<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat Privado - Acesso Restrito</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: #0d0d0d; color: #e0e0e0; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* TELA DE LOGIN */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .login-box { width: 100%; max-width: 350px; }
        h1 { color: #00E676; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
        input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #333; background: #1a1a1a; color: #fff; font-size: 1.1em; outline: none; transition: 0.3s; }
        input:focus { border-color: #00E676; }
        .btn-enter { width: 100%; padding: 15px; background: #00E676; color: #000; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1em; cursor: pointer; text-transform: uppercase; }

        /* TELA DO CHAT */
        #chatScreen { display: none; flex-direction: column; height: 100%; width: 100%; max-width: 600px; margin: 0 auto; background: #121212; border-left: 1px solid #222; border-right: 1px solid #222; }
        
        .chat-header { padding: 15px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .status-dot { width: 10px; height: 10px; background: #00E676; border-radius: 50%; display: inline-block; margin-right: 5px; animation: pulse 2s infinite; }
        .btn-nuke { background: transparent; border: 1px solid #FF4444; color: #FF4444; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em; }

        .chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background-image: radial-gradient(#1a1a1a 1px, transparent 1px); background-size: 20px 20px; }
        
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 0.95em; line-height: 1.4; position: relative; word-wrap: break-word; }
        .msg-me { align-self: flex-end; background: #005c4b; color: #fff; border-bottom-right-radius: 2px; }
        .msg-other { align-self: flex-start; background: #262d31; color: #fff; border-bottom-left-radius: 2px; }
        .msg-info { font-size: 0.7em; color: rgba(255,255,255,0.5); text-align: right; margin-top: 5px; display: block; }
        .sender-name { font-size: 0.7em; font-weight: bold; color: #00E676; display: block; margin-bottom: 3px; }

        .input-area { padding: 15px; background: #1a1a1a; border-top: 1px solid #333; display: flex; gap: 10px; }
        .msg-input { flex: 1; padding: 12px; border-radius: 25px; background: #2a2a2a; border: none; color: white; outline: none; }
        .btn-send { background: #00E676; color: #000; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2em; transition: transform 0.1s; }
        .btn-send:active { transform: scale(0.9); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <audio id="somMsg" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>

    <div id="loginScreen">
        <div class="login-box">
            <h1>üîê Chat Secreto</h1>
            <p style="color:#888; font-size:0.9em; margin-bottom:20px;">Use a mesma senha que a outra pessoa para se conectarem.</p>
            <input type="text" id="inputNome" placeholder="Seu Apelido (ex: Gil)">
            <input type="password" id="inputSenhaSala" placeholder="Senha da Sala (Chave Secreta)">
            <button class="btn-enter" onclick="entrarNoChat()">Entrar na Sala</button>
        </div>
    </div>

    <div id="chatScreen">
        <div class="chat-header">
            <div>
                <span class="status-dot"></span>
                <span style="font-weight:bold; color:#fff;">Sala: <span id="displaySala">...</span></span>
            </div>
            <button class="btn-nuke" onclick="apagarTudo()">üí• Apagar Tudo</button>
        </div>

        <div id="chatArea" class="chat-area">
            </div>

        <div class="input-area">
            <input type="text" id="msgInput" class="msg-input" placeholder="Digite sua mensagem..." onkeypress="if(event.key === 'Enter') enviarMensagem()">
            <button class="btn-send" onclick="enviarMensagem()">‚û§</button>
        </div>
    </div>

    <script>
        // 2. CONFIGURA√á√ÉO (GARANTINDO QUE CARREGA DEPOIS DAS LIBS)
        const firebaseConfig = { apiKey: "AIzaSyDLPi5Mf6_9ypigmf3v9Qe9YYPUr1mfaHk", authDomain: "gil-eventos-app-911fe.firebaseapp.com", projectId: "gil-eventos-app-911fe", storageBucket: "gil-eventos-app-911fe.firebasestorage.app", messagingSenderId: "503025880352", appId: "1:503025880352:web:694b7f2889cff501c7db45", measurementId: "G-3DZ1P5C0M3" };
        
        // Verifica se carregou
        if (typeof firebase === 'undefined') {
            alert("Erro cr√≠tico: Firebase n√£o carregou. Verifique sua internet e recarregue a p√°gina.");
        } else {
            firebase.initializeApp(firebaseConfig);
        }
        
        const db = firebase.firestore();

        let MEU_NOME = "";
        let MINHA_SALA = "";

        function entrarNoChat() {
            const nome = document.getElementById('inputNome').value.trim();
            const senha = document.getElementById('inputSenhaSala').value.trim();

            if(!nome || !senha) return alert("Preencha seu apelido e a senha da sala!");

            MEU_NOME = nome;
            MINHA_SALA = senha; 

            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'flex';
            document.getElementById('displaySala').innerText = senha;

            monitorarMensagens();
        }

        function monitorarMensagens() {
            const area = document.getElementById('chatArea');
            
            // ATEN√á√ÉO: Se n√£o funcionar, verifique se a cole√ß√£o 'chat_secreto' existe ou se as regras do Firebase permitem escrita
            db.collection("chat_secreto")
              .where("sala_id", "==", MINHA_SALA)
              .onSnapshot(snapshot => {
                  area.innerHTML = ''; 
                  
                  if(snapshot.empty) {
                      area.innerHTML = '<p style="text-align:center; color:#555; margin-top:50px;">Inicie a conversa... üîí</p>';
                      return;
                  }

                  let mensagens = [];
                  snapshot.forEach(doc => {
                      mensagens.push(doc.data());
                  });

                  // Ordena√ß√£o via Javascript para evitar erro de √≠ndice
                  mensagens.sort((a, b) => {
                      let dateA = a.data ? a.data.toDate() : new Date();
                      let dateB = b.data ? b.data.toDate() : new Date();
                      return dateA - dateB;
                  });

                  mensagens.forEach(m => {
                      const souEu = m.nome === MEU_NOME;
                      const classe = souEu ? 'msg-me' : 'msg-other';
                      const nomeDisplay = souEu ? '' : `<span class="sender-name">${m.nome}</span>`;
                      const hora = m.data ? m.data.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';

                      area.innerHTML += `
                        <div class="msg ${classe}">
                            ${nomeDisplay}
                            ${m.texto}
                            <span class="msg-info">${hora}</span>
                        </div>
                      `;
                  });

                  area.scrollTop = area.scrollHeight;

                  snapshot.docChanges().forEach(change => {
                      if (change.type === "added") {
                          const dados = change.doc.data();
                          const agora = new Date();
                          const msgData = dados.data ? dados.data.toDate() : new Date();
                          const diff = (agora - msgData) / 1000;

                          if(dados.nome !== MEU_NOME && diff < 60) {
                              document.getElementById('somMsg').play().catch(()=>{});
                          }
                      }
                  });
              });
        }

        function enviarMensagem() {
            const input = document.getElementById('msgInput');
            const texto = input.value.trim();
            if(!texto) return;

            db.collection("chat_secreto").add({
                sala_id: MINHA_SALA, 
                nome: MEU_NOME,
                texto: texto,
                data: new Date()
            }).catch(err => {
                console.error("Erro ao enviar:", err);
                alert("Erro ao enviar mensagem. Tente novamente.");
            });

            input.value = '';
            input.focus();
        }

        function apagarTudo() {
            if(!confirm("Tem certeza? Isso apagar√° a conversa para AMBOS para sempre.")) return;

            db.collection("chat_secreto").where("sala_id", "==", MINHA_SALA).get().then(snapshot => {
                const batch = db.batch();
                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                batch.commit().then(() => alert("Conversa apagada!"));
            });
        }
    </script>
</body>
</html>
