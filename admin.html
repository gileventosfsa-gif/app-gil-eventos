<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurar Evento - Gil Eventos</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #121212; color: #EAEAEA; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        h1 { color: #FFD580; text-align: center; text-transform: uppercase; letter-spacing: 2px; }
        .card { background: #1E1E1E; padding: 25px; border-radius: 15px; border: 1px solid #333; margin-bottom: 20px; }
        label { display: block; margin-top: 15px; color: #FFD580; font-size: 0.9em; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; background: #2A2A2A; border: 1px solid #444; color: #fff; border-radius: 8px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; background: linear-gradient(90deg, #FF6700, #FF9500); border: none; color: white; font-weight: bold; border-radius: 8px; margin-top: 25px; cursor: pointer; transition: 0.3s; }
        
        .drink-item { background: #252525; border: 1px solid #444; padding: 15px; border-radius: 10px; margin-bottom: 10px; position: relative; }
        .drink-header { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .input-nome { flex: 2; font-weight: bold; color: #FFD580; }
        .configs-row { display: flex; gap: 10px; margin-top: 10px; background: #1a1a1a; padding: 10px; border-radius: 8px; flex-wrap: wrap; }
        .config-group { flex: 1; min-width: 120px; }
        .config-label { font-size: 0.75em; color: #888; margin-bottom: 3px; display: block; }
        .select-mini { width: 100%; padding: 8px; font-size: 0.9em; border: 1px solid #555; }
        .btn-add { background: #333; border: 1px dashed #777; color: #aaa; width: 100%; padding: 15px; border-radius: 10px; cursor: pointer; margin-top: 10px; }
        .btn-restore { background: #444; border: 1px solid #666; color: #FFD580; width: 100%; padding: 10px; border-radius: 8px; cursor: pointer; margin-bottom: 15px; font-size: 0.9em; font-weight: bold; }
        
        .row { display: flex; gap: 10px; } .col { flex: 1; }
        
        /* Estilos Espec√≠ficos do Misto */
        #selectComboMisto { border: 2px solid #FF9500; background: #2A2210; color: #FFD580; font-weight: bold; }
        #boxMistoPersonalizado { background: #2A2210; padding: 10px; border-radius: 8px; border: 1px dashed #FF9500; margin-top: 10px; display: none; }
        .mini-label { font-size: 0.8em; color: #FFD580; margin-bottom: 2px; display: block; }
    </style>
</head>
<body>
<div class="container">
    <h1 id="tituloPagina">Novo Evento ‚öôÔ∏è</h1>
    <div class="card">
        <label>Nome do Evento</label>
        <input type="text" id="nomeEvento" placeholder="Ex: Casamento Ana">
        
        <div class="row">
            <div class="col">
                <label>Modelo do Contrato</label>
                <select id="tipoServico" onchange="togglePacote()">
                    <option value="pacote">üì¶ Pacote Cl√°ssico</option>
                    <option value="premium">üëë Pacote Premium</option>
                    <option value="misto">üåü Pacote Misto</option>
                    <option value="tradicional">üçπ Tradicional (Open)</option>
                </select>
            </div>
            <div class="col" id="boxQuantidade">
                <label id="labelQtd">Limite Total (Drinks)</label>
                
                <input type="number" id="qtdPacote" placeholder="Ex: 300">
                
                <select id="selectComboMisto" style="display:none;" onchange="verificarPersonalizado()"></select>
                
                <div id="boxMistoPersonalizado">
                    <div class="row">
                        <div class="col">
                            <span class="mini-label">Qtd. Cl√°ssicos</span>
                            <input type="number" id="manualClassico" placeholder="0">
                        </div>
                        <div class="col">
                            <span class="mini-label">Qtd. Premiums</span>
                            <input type="number" id="manualPremium" placeholder="0">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <label>Chave PIX (Para vendas)</label>
        <input type="text" id="chavePix" placeholder="E-mail ou CPF">

        <label style="margin-top:25px; border-top:1px solid #333; padding-top:15px;">Card√°pio Oficial & Pre√ßos</label>
        
        <button class="btn-restore" onclick="restaurarCardapioPadrao()">üîÑ RESTAURAR CARD√ÅPIO OFICIAL</button>
        
        <div id="listaDrinksEditor"></div>
        <button class="btn-add" onclick="adicionarNovoDrink()">+ ADICIONAR NOVO DRINK</button>

        <div class="row" style="margin-top:25px; padding-top:15px; border-top:1px solid #333;">
            <div class="col">
                <label>Timer de Bloqueio (min)</label>
                <input type="number" id="timerBloqueio" value="15" placeholder="Tempo entre pedidos">
            </div>
            <div class="col">
                <label>Limite Drinks por Vez</label>
                <input type="number" id="limitePorPedido" value="3" placeholder="Padr√£o: 3">
            </div>
        </div>

        <label>Senha Admin</label>
        <input type="text" id="senhaAdmin" placeholder="Senha mestre">

        <button class="btn" id="btnSalvar" onclick="salvarEvento()">CRIAR EVENTO</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDLPi5Mf6_9ypigmf3v9Qe9YYPUr1mfaHk",
        authDomain: "gil-eventos-app-911fe.firebaseapp.com",
        projectId: "gil-eventos-app-911fe",
        storageBucket: "gil-eventos-app-911fe.firebasestorage.app",
        messagingSenderId: "503025880352",
        appId: "1:503025880352:web:694b7f2889cff501c7db45",
        measurementId: "G-3DZ1P5C0M3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const params = new URLSearchParams(window.location.search);
    const EVENTO_ID = params.get('evento');
    
    let TIPO_ORIGINAL = '';

    const COMBOS_MISTOS = [
        { total: 100, classicos: 70, premiums: 30, label: "100 Drinks (70 Cl√°s + 30 Prem) - R$1.050" },
        { total: 150, classicos: 100, premiums: 50, label: "150 Drinks (100 Cl√°s + 50 Prem) - R$1.350" },
        { total: 200, classicos: 140, premiums: 60, label: "200 Drinks (140 Cl√°s + 60 Prem) - R$1.650" },
        { total: 250, classicos: 170, premiums: 80, label: "250 Drinks (170 Cl√°s + 80 Prem) - R$1.950" },
        { total: 300, classicos: 200, premiums: 100, label: "300 Drinks (200 Cl√°s + 100 Prem) - R$2.250" },
        { total: 400, classicos: 300, premiums: 100, label: "400 Drinks (300 Cl√°s + 100 Prem) - R$2.550" },
        { total: 500, classicos: 400, premiums: 100, label: "500 Drinks (400 Cl√°s + 100 Prem) - R$2.850" },
        { total: 600, classicos: 500, premiums: 100, label: "600 Drinks (500 Cl√°s + 100 Prem) - R$3.150" },
        { total: 750, classicos: 600, premiums: 150, label: "750 Drinks (600 Cl√°s + 150 Prem) - R$3.450" },
        { total: 900, classicos: 700, premiums: 200, label: "900 Drinks (700 Cl√°s + 200 Prem) - R$3.750" },
        { total: 0, classicos: 0, premiums: 0, label: "‚úèÔ∏è PERSONALIZADO (Definir Quantidades)" }
    ];

    const CARDAPIO_PADRAO = [
        { nome: "Elixir do Sol", desc: "Abacaxi, hortel√£, toque c√≠trico e especiarias.", categoria: "classico", tipo_cobranca: "pacote", preco: 10, preco_prevenda: 8 },
        { nome: "Desejo Proibido", desc: "Frutas vermelhas intensas, c√≠trico e hortel√£.", categoria: "classico", tipo_cobranca: "pacote", preco: 10, preco_prevenda: 8 },
        { nome: "Encanto Noturno", desc: "Uva roxa, c√≠trico e manjeric√£o fresco.", categoria: "classico", tipo_cobranca: "pacote", preco: 10, preco_prevenda: 8 },
        { nome: "Tropical Mix", desc: "Tangerina, kiwi, abacaxi e ervas frescas.", categoria: "classico", tipo_cobranca: "pacote", preco: 12, preco_prevenda: 10 },
        { nome: "Brisa Verde", desc: "Lim√£o, gengibre, manjeric√£o e a√ß√∫car de cana.", categoria: "classico", tipo_cobranca: "pacote", preco: 10, preco_prevenda: 8 },
        { nome: "F√∫ria Rubi", desc: "Morango, tangerina e maracuj√°.", categoria: "classico", tipo_cobranca: "pacote", preco: 12, preco_prevenda: 10 },
        { nome: "Caipirinha Premium", desc: "Lim√£o tahiti, a√ß√∫car na medida e aguardente.", categoria: "classico", tipo_cobranca: "pacote", preco: 10, preco_prevenda: 8 },
        { nome: "Segredo da Casa", desc: "Cria√ß√£o autoral com toque secreto.", categoria: "classico", tipo_cobranca: "pacote", preco: 10, preco_prevenda: 8 },
        { nome: "Aperol Sunset", desc: "Aperol com espumante e laranja caramelizada.", categoria: "premium", tipo_cobranca: "pacote", preco: 25, preco_prevenda: 20 },
        { nome: "Gin Tropical", desc: "Gin, abacaxi grelhado e especiarias.", categoria: "premium", tipo_cobranca: "pacote", preco: 25, preco_prevenda: 20 },
        { nome: "Mojito da Ilha", desc: "Rum branco, hortel√£ fresca e lim√£o.", categoria: "premium", tipo_cobranca: "pacote", preco: 25, preco_prevenda: 20 },
        { nome: "Coquetel Kids", desc: "Mix cremoso de frutas vermelhas.", categoria: "classico", tipo_cobranca: "pacote", preco: 10, preco_prevenda: 8 },
        { nome: "Personalizado", desc: "O cliente escolhe as frutas.", categoria: "classico", tipo_cobranca: "pacote", preco: 12, preco_prevenda: 10 }
    ];

    let cardapioAtual = JSON.parse(JSON.stringify(CARDAPIO_PADRAO));

    const selectMisto = document.getElementById('selectComboMisto');
    COMBOS_MISTOS.forEach((combo, index) => {
        const opt = document.createElement('option');
        opt.value = index;
        opt.innerText = combo.label;
        selectMisto.appendChild(opt);
    });

    if(EVENTO_ID) {
        document.getElementById('tituloPagina').innerText = "Editar Evento ‚úèÔ∏è";
        document.getElementById('btnSalvar').innerText = "SALVAR ALTERA√á√ïES";
        carregarDadosEdicao();
    } else {
        renderizarEditor();
    }

    function carregarDadosEdicao() {
        db.collection("eventos").doc(EVENTO_ID).get().then((doc) => {
            if(doc.exists) {
                const dados = doc.data();
                TIPO_ORIGINAL = dados.tipo_servico;

                document.getElementById('nomeEvento').value = dados.nome;
                document.getElementById('tipoServico').value = dados.tipo_servico;
                document.getElementById('qtdPacote').value = dados.total_contratado;
                
                if(dados.tipo_servico === 'misto') {
                    const idx = COMBOS_MISTOS.findIndex(c => 
                        c.total === dados.total_contratado && 
                        c.classicos === dados.limite_classico && 
                        c.premiums === dados.limite_premium
                    );

                    if(idx !== -1 && COMBOS_MISTOS[idx].total > 0) {
                        document.getElementById('selectComboMisto').value = idx;
                    } else {
                        document.getElementById('selectComboMisto').value = COMBOS_MISTOS.length - 1; 
                        document.getElementById('manualClassico').value = dados.limite_classico;
                        document.getElementById('manualPremium').value = dados.limite_premium;
                    }
                }

                document.getElementById('chavePix').value = dados.chave_pix || "";
                
                // CARREGA OS VALORES SALVOS (OU PADR√ÉO SE N√ÉO EXISTIR)
                document.getElementById('timerBloqueio').value = dados.timer_minutos !== undefined ? dados.timer_minutos : 15;
                document.getElementById('limitePorPedido').value = dados.limite_pedido !== undefined ? dados.limite_pedido : 3;

                document.getElementById('senhaAdmin').value = dados.senha_admin;
                
                if(dados.cardapio && dados.cardapio.length > 0) {
                    cardapioAtual = dados.cardapio;
                } else {
                    cardapioAtual = JSON.parse(JSON.stringify(CARDAPIO_PADRAO));
                }
                
                togglePacote();
                renderizarEditor();
            }
        });
    }

    function restaurarCardapioPadrao() {
        if(confirm("Deseja substituir a lista atual pelo Card√°pio Oficial completo?")) {
            cardapioAtual = JSON.parse(JSON.stringify(CARDAPIO_PADRAO));
            renderizarEditor();
        }
    }

    function renderizarEditor() {
        const container = document.getElementById('listaDrinksEditor');
        container.innerHTML = '';
        cardapioAtual.forEach((drink, index) => {
            const div = document.createElement('div');
            div.className = 'drink-item';
            div.innerHTML = `
                <div class="drink-header">
                    <input type="text" value="${drink.nome}" class="input-nome" placeholder="Nome">
                    <button style="background:#ff4444; border:none; color:white; border-radius:5px; padding:5px 10px; cursor:pointer;" onclick="removerDrink(${index})">üóëÔ∏è</button>
                </div>
                <textarea rows="2" class="input-desc" placeholder="Descri√ß√£o">${drink.desc}</textarea>
                <div class="configs-row">
                    <div class="config-group">
                        <span class="config-label">CATEGORIA</span>
                        <select class="select-mini input-cat">
                            <option value="classico" ${drink.categoria==='classico'?'selected':''}>ü•É Cl√°ssico</option>
                            <option value="premium" ${drink.categoria==='premium'?'selected':''}>üíé Premium</option>
                        </select>
                    </div>
                    <div class="config-group">
                        <span class="config-label">CONTRATO</span>
                        <select class="select-mini input-cob">
                            <option value="pacote" ${drink.tipo_cobranca==='pacote'?'selected':''}>üÜì Pacote</option>
                            <option value="pago" ${drink.tipo_cobranca==='pago'?'selected':''}>üí≤ Pago</option>
                        </select>
                    </div>
                    <div class="config-group"><span class="config-label">R$ PR√â-VENDA</span><input type="number" value="${drink.preco_prevenda||0}" class="input-preco-prevenda select-mini"></div>
                    <div class="config-group"><span class="config-label">R$ NO DIA</span><input type="number" value="${drink.preco||0}" class="input-preco select-mini"></div>
                </div>`;
            container.appendChild(div);
        });
    }

    function adicionarNovoDrink() { cardapioAtual.push({ nome: "", desc: "", categoria: "classico", tipo_cobranca: "pacote", preco: 0, preco_prevenda: 0 }); renderizarEditor(); }
    function removerDrink(index) { cardapioAtual.splice(index, 1); renderizarEditor(); }
    
    function togglePacote() { 
        const t = document.getElementById('tipoServico').value; 
        const box = document.getElementById('boxQuantidade');
        const inputNormal = document.getElementById('qtdPacote');
        const selectMisto = document.getElementById('selectComboMisto');
        const label = document.getElementById('labelQtd');

        box.style.display = (t === 'tradicional') ? 'none' : 'block';
        
        if (t === 'tradicional') {
            inputNormal.value = 999999;
        } else if (t === 'misto') {
            label.innerText = "Selecione o Combo";
            inputNormal.style.display = 'none';
            selectMisto.style.display = 'block';
            verificarPersonalizado(); 
        } else {
            label.innerText = "Limite Total (Drinks)";
            inputNormal.style.display = 'block';
            selectMisto.style.display = 'none';
            document.getElementById('boxMistoPersonalizado').style.display = 'none';
        }
    }

    function verificarPersonalizado() {
        const idx = document.getElementById('selectComboMisto').value;
        const combo = COMBOS_MISTOS[idx];
        const boxManual = document.getElementById('boxMistoPersonalizado');
        
        if (combo.label.includes("PERSONALIZADO")) {
            boxManual.style.display = 'block';
        } else {
            boxManual.style.display = 'none';
        }
    }

    async function salvarEvento() {
        const nome = document.getElementById('nomeEvento').value;
        const tipo = document.getElementById('tipoServico').value;
        const pix = document.getElementById('chavePix').value || "N√£o informada";
        
        // PEGA OS VALORES DOS INPUTS
        const timer = parseInt(document.getElementById('timerBloqueio').value) || 15;
        const limitePedido = parseInt(document.getElementById('limitePorPedido').value) || 3;
        
        const senha = document.getElementById('senhaAdmin').value;
        
        let qtdTotal = 0;
        let limiteClassico = 0;
        let limitePremium = 0;

        if (tipo === 'misto') {
            const idx = document.getElementById('selectComboMisto').value;
            const combo = COMBOS_MISTOS[idx];
            
            if (combo.label.includes("PERSONALIZADO")) {
                limiteClassico = parseInt(document.getElementById('manualClassico').value) || 0;
                limitePremium = parseInt(document.getElementById('manualPremium').value) || 0;
                qtdTotal = limiteClassico + limitePremium;
            } else {
                qtdTotal = combo.total;
                limiteClassico = combo.classicos;
                limitePremium = combo.premiums;
            }
        } else {
            qtdTotal = parseInt(document.getElementById('qtdPacote').value) || 0;
            limiteClassico = qtdTotal; 
            limitePremium = qtdTotal;
        }

        let cardapioFinal = [];
        document.querySelectorAll('.drink-item').forEach(item => {
            cardapioFinal.push({
                nome: item.querySelector('.input-nome').value,
                desc: item.querySelector('.input-desc').value,
                categoria: item.querySelector('.input-cat').value,
                tipo_cobranca: item.querySelector('.input-cob').value,
                preco: parseFloat(item.querySelector('.input-preco').value) || 0,
                preco_prevenda: parseFloat(item.querySelector('.input-preco-prevenda').value) || 0,
                disponivel: true 
            });
        });

        if(!nome || !senha) return alert("Preencha campos obrigat√≥rios!");
        const btn = document.getElementById('btnSalvar'); btn.innerText = "Salvando..."; btn.disabled = true;

        const dados = { 
            nome: nome, 
            tipo_servico: tipo, 
            total_contratado: qtdTotal, 
            limite_classico: limiteClassico, 
            limite_premium: limitePremium,
            chave_pix: pix, 
            timer_minutos: timer,
            limite_pedido: limitePedido, // SALVA O LIMITE
            senha_admin: senha, 
            cardapio: cardapioFinal 
        };

        if(EVENTO_ID) {
            if (tipo !== TIPO_ORIGINAL) {
                if(confirm("‚ö†Ô∏è MUDAN√áA CR√çTICA DE PACOTE DETECTADA!\n\nDeseja ZERAR TUDO?\n(Isso vai zerar contadores, faturamento e APAGAR TODO O HIST√ìRICO de pedidos deste evento)")) {
                    dados.total_consumido = 0;
                    dados.consumido_classico = 0;
                    dados.consumido_premium = 0;
                    dados.total_vendas_extra = 0;
                    dados.total_faturamento = 0;
                    try {
                        const batch = db.batch();
                        const snapshot = await db.collection("pedidos").where("evento_id", "==", EVENTO_ID).get();
                        if (!snapshot.empty) {
                            snapshot.forEach(doc => { batch.delete(doc.ref); });
                            await batch.commit();
                        }
                    } catch (error) { console.error("Erro ao limpar pedidos:", error); }
                }
            }
            db.collection("eventos").doc(EVENTO_ID).update(dados).then(() => { 
                alert("Evento Atualizado!"); 
                window.location.href = `dashboard.html?evento=${EVENTO_ID}`; 
            });
        } else {
            dados.total_consumido = 0; 
            dados.consumido_classico = 0; 
            dados.consumido_premium = 0; 
            dados.total_vendas_extra = 0; 
            dados.total_faturamento = 0; 
            dados.ativo = true; 
            dados.data_criacao = new Date(); 
            dados.modo_preco = 'normal';
            
            db.collection("eventos").add(dados).then((docRef) => { window.location.href = `dashboard.html?evento=${docRef.id}`; });
        }
    }
    togglePacote();
</script>
</body>
</html>
