<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Card√°pio Digital</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #0F0F0F; background-image: radial-gradient(circle at top right, #1a1a1a, #0F0F0F); color: #EAEAEA; margin: 0; padding: 20px; -webkit-tap-highlight-color: transparent; padding-bottom: 90px; }
        .container { max-width: 600px; margin: auto; }
        .header { text-align: center; margin-bottom: 30px; margin-top: 10px; }
        .brand-subtitle { color: #FFD580; font-size: 0.8em; letter-spacing: 2px; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .event-name { color: #fff; font-size: 1.8em; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .section-title { color: #FFD580; border-bottom: 1px solid #333; padding-bottom: 5px; margin: 30px 0 15px 0; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px; }
        
        /* CARD COM FOTO CORRIGIDA */
        .drink-card { 
            background: #1E1E1E; 
            border-radius: 16px; 
            margin-bottom: 25px; 
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid #333;
            transition: transform 0.2s;
        }
        .drink-card:active { transform: scale(0.98); }
        
        .card-image-box {
            width: 100%;
            height: 180px;
            position: relative;
            background: #000;
        }
        .card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.9;
        }
        .card-image-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(to top, #1E1E1E, transparent);
        }

        .drink-content { padding: 15px 20px; position: relative; }
        .drink-title { font-size: 1.3em; font-weight: 700; color: #fff; margin: 0; }
        .drink-desc { font-size: 0.9em; color: #bbb; margin: 5px 0 15px 0; line-height: 1.4; font-weight: 300; }
        
        /* PRE√áOS */
        .price-tag-container { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); padding: 5px 12px; border-radius: 20px; border: 1px solid #FFD580; text-align: right; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 2; }
        .price-old { text-decoration: line-through; color: #FF4444; font-size: 0.75em; display: block; font-weight: bold; }
        .price-now { color: #4CAF50; font-weight: 800; font-size: 1.1em; }
        
        .btn-action { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; font-size: 1em; text-transform: uppercase; letter-spacing: 0.5px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-free { background: linear-gradient(45deg, #2E7D32, #4CAF50); color: white; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); }
        .btn-paid { background: linear-gradient(45deg, #FF8F00, #FFD580); color: #000; box-shadow: 0 4px 15px rgba(255, 143, 0, 0.3); }
        .btn-blocked { background: #333; color: #666; cursor: not-allowed; border: 1px solid #444; }

        /* FLOATING BUTTON */
        .float-btn { position: fixed; bottom: 20px; right: 20px; background: #FFD580; color: #000; padding: 15px 25px; border-radius: 50px; font-weight: bold; box-shadow: 0 5px 20px rgba(255, 213, 128, 0.4); cursor: pointer; z-index: 500; display: none; align-items: center; gap: 10px; }
        .float-badge { background: #FF4444; color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.75em; font-weight: bold; }

        /* MODAIS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 900; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-box { background: #1E1E1E; padding: 25px; border-radius: 20px; text-align: center; width: 90%; max-width: 400px; border: 1px solid #333; max-height: 85vh; display: flex; flex-direction: column; }
        
        .input-nome, .input-obs { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #444; background: #111; color: #fff; box-sizing: border-box; font-size: 1em; }
        .btn-confirm { width: 100%; padding: 15px; background: #FFD580; color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1em; }
        
        .modal-tabs { display: flex; border-bottom: 1px solid #333; margin-bottom: 15px; }
        .tab-btn { flex: 1; background: none; border: none; color: #777; padding: 12px; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: #FFD580; border-bottom-color: #FFD580; }
        .tab-alert { width: 10px; height: 10px; background: #FF4444; border-radius: 50%; position: absolute; top: 8px; right: 15px; display: none; }
        
        .tab-content { display: none; flex-grow: 1; overflow-y: auto; max-height: 300px; }
        .tab-content.active { display: block; }

        /* CHAT */
        .chat-container { display: flex; flex-direction: column; height: 300px; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .chat-input-area { display: flex; gap: 8px; margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; }
        .chat-input { flex: 1; background: #111; border: 1px solid #444; color: white; padding: 12px; border-radius: 25px; outline: none; }
        .chat-send { background: #FFD580; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2em; color: black; }
        
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 80%; font-size: 0.9em; line-height: 1.4; position: relative; }
        .msg-mine { background: #2E7D32; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-admin { background: #333; color: #ddd; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #444; }
        .msg-time { font-size: 0.65em; opacity: 0.7; display: block; text-align: right; margin-top: 4px; }

        .my-order-item { background: #222; padding: 15px; border-radius: 10px; margin-bottom: 12px; text-align: left; border-left: 4px solid #555; }
        .payment-alert { background: rgba(255, 68, 68, 0.1); color: #FF4444; padding: 10px; font-size: 0.85em; border-radius: 6px; margin-top: 10px; display: block; border: 1px dashed #FF4444; text-align: center; font-weight: 500; }
        .btn-client-action { width: 100%; margin-top: 5px; padding: 8px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; font-size: 0.8em; }
        .btn-i-paid { background: #4CAF50; color: white; }
        .btn-client-cancel { background: transparent; border: 1px solid #777; color: #aaa; margin-top: 5px; }

        #avisoPacote { background: rgba(255, 68, 68, 0.15); border: 1px solid #FF4444; color: #FF4444; padding: 15px; border-radius: 10px; text-align: center; font-weight: bold; margin-bottom: 25px; display: none; }
        #notification { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: #1a1a1a; color: #fff; padding: 12px 25px; border-radius: 50px; display:none; border: 1px solid #FFD580; z-index:950; white-space:nowrap; box-shadow: 0 5px 20px rgba(0,0,0,0.5); font-size: 0.9em; }
        
        .pix-area { background: #252525; padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px dashed #FFD580; text-align: left; }
        .pix-key { font-family: monospace; color: #FFD580; font-size: 1.1em; word-break: break-all; margin-bottom: 10px; display: block; background: #111; padding: 10px; border-radius: 5px; text-align: center; }
        
        .ready-alert { animation: pulse 1.5s infinite; border: 2px solid #4CAF50; background: rgba(76, 175, 80, 0.1); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(76, 175, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <span class="brand-subtitle">GIL EVENTOS</span>
        <div class="event-name" id="nomeEvento">Carregando...</div>
        <div class="welcome-user">Ol√°, <span id="displayNome">Visitante</span> üëã</div>
    </div>
    <div id="avisoPacote">‚ö†Ô∏è PACOTE ESGOTADO</div>
    <div id="listaCardapio"></div>
</div>

<div class="float-btn" id="btnMeusPedidos" onclick="abrirMeusPedidos()">üçπ Pedidos / Chat <div class="float-badge" id="badgeMeusPedidos">0</div></div>

<div class="modal-overlay" id="modalNome" style="display:flex;"><div class="modal-box"><h3>Bem-vindo!</h3><p style="color:#aaa;">Como devemos te chamar?</p><input type="text" id="inputNomeConvidado" class="input-nome" placeholder="Seu Nome"><button class="btn-confirm" onclick="salvarNome()">ENTRAR</button></div></div>

<div class="modal-overlay" id="modalConfirm"><div class="modal-box"><h2 style="color:#FFD580; margin:0;">Confirmar Pedido</h2><div id="conteudoConfirmacao"></div><textarea id="inputObservacao" class="input-obs" placeholder="Alguma prefer√™ncia? (Ex: Pouco gelo)"></textarea><button class="btn-confirm" id="btnFinalizar">ENVIAR PEDIDO</button><button onclick="document.getElementById('modalConfirm').style.display='none'" style="background:none; border:none; color:#888; margin-top:15px; text-decoration:underline; cursor:pointer;">Cancelar</button></div></div>

<div class="modal-overlay" id="modalListaPedidos">
    <div class="modal-box" style="height: 550px;">
        <div class="modal-tabs">
            <button class="tab-btn active" onclick="mudarAba('pedidos')">üìù Meus Pedidos</button>
            <button class="tab-btn" onclick="mudarAba('chat')">üí¨ Chat <span id="alertChatTab" class="tab-alert"></span></button>
        </div>

        <div id="tab-pedidos" class="tab-content active">
            <div style="background:#252525; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #FFD580; text-align:left;">
                <small style="color:#FFD580; font-weight:bold; display:block; margin-bottom:5px;">üîî Receba novidades!</small>
                <div style="display:flex; gap:8px;">
                    <input type="tel" id="mktZap" style="background:#111; border:1px solid #444; color:white; padding:8px; border-radius:8px; flex:1; width:100%;" placeholder="Seu WhatsApp">
                    <button onclick="salvarZap()" style="background:#4CAF50; border:none; color:white; padding:8px 15px; border-radius:8px; font-weight:bold; cursor:pointer;">Salvar</button>
                </div>
            </div>
            <div id="listaMeusPedidosHTML"></div>
        </div>

        <div id="tab-chat" class="tab-content">
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"><p style="text-align:center; color:#555; font-size:0.8em; margin-top:20px;">Fale diretamente com o barman aqui.</p></div>
                <div class="chat-input-area"><input type="text" id="chatInput" class="chat-input" placeholder="Digite sua mensagem..."><button class="chat-send" onclick="enviarMensagem()">‚û§</button></div>
            </div>
        </div>

        <button class="btn-confirm" onclick="document.getElementById('modalListaPedidos').style.display='none'" style="margin-top:15px; background:#333; color:#fff;">FECHAR</button>
    </div>
</div>

<div class="modal-overlay" id="modalPronto"><div class="modal-box ready-alert"><div style="font-size:4em;">üéâ</div><h2 style="color:#4CAF50;">SEU DRINK T√Å PRONTO!</h2><p style="color:#fff;">Pode buscar no balc√£o.</p><button class="btn-confirm" style="background:#4CAF50;" onclick="document.getElementById('modalPronto').style.display='none'">J√Å PEGUEI</button></div></div>
<div id="notification"></div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDLPi5Mf6_9ypigmf3v9Qe9YYPUr1mfaHk",
        authDomain: "gil-eventos-app-911fe.firebaseapp.com",
        projectId: "gil-eventos-app-911fe",
        storageBucket: "gil-eventos-app-911fe.firebasestorage.app",
        messagingSenderId: "503025880352",
        appId: "1:503025880352:web:694b7f2889cff501c7db45",
        measurementId: "G-3DZ1P5C0M3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const params = new URLSearchParams(window.location.search);
    const EVENTO_ID = params.get('evento');
    let DADOS_EVENTO = null;
    let NOME_CONVIDADO = localStorage.getItem('nome_usuario_gil');
    let TIMER_MINUTOS = 15;
    let ITEM_ATUAL = null;
    let MEUS_PEDIDOS_IDS = JSON.parse(localStorage.getItem(`pedidos_${EVENTO_ID}`) || "[]");

    if(NOME_CONVIDADO) { document.getElementById('modalNome').style.display = 'none'; document.getElementById('displayNome').innerText = NOME_CONVIDADO; }
    if(EVENTO_ID) iniciarApp();

    function iniciarApp() {
        db.collection("eventos").doc(EVENTO_ID).onSnapshot((doc) => {
            if(doc.exists) {
                DADOS_EVENTO = doc.data();
                if (DADOS_EVENTO.timer_minutos !== undefined && DADOS_EVENTO.timer_minutos !== null) TIMER_MINUTOS = DADOS_EVENTO.timer_minutos; else TIMER_MINUTOS = 15;
                renderizarCardapio();
                verificarTimer();
            }
        });
        if(MEUS_PEDIDOS_IDS.length > 0) rastrearPedidos();
        if(NOME_CONVIDADO) carregarChat(); 
    }

    // --- SISTEMA DE IMAGENS ROBUSTO (SEM ERRO) ---
    function getDrinkImage(nome) {
        const n = nome.toLowerCase();
        
        // 1. GIN
        if(n.includes('gin') || n.includes('t√¥nica')) return 'https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?auto=format&fit=crop&w=600&q=80';
        
        // 2. TROPICAL / AMARELO
        if(n.includes('tropical') || n.includes('fruta') || n.includes('maracuj') || n.includes('manga') || n.includes('sol')) 
            return 'https://images.unsplash.com/photo-1596701062351-8c2c14d1fdd0?auto=format&fit=crop&w=600&q=80';
        
        // 3. VERMELHO / MORANGO / FRUTAS VERMELHAS
        if(n.includes('morango') || n.includes('vermelh') || n.includes('rubi')) 
            return 'https://images.unsplash.com/photo-1560512823-8db03e1b0949?auto=format&fit=crop&w=600&q=80';
        
        // 4. LIM√ÉO / CAIPIRINHA / VERDE
        if(n.includes('lim√£o') || n.includes('caipir') || n.includes('mojito') || n.includes('hortel√£')) 
            return 'https://images.unsplash.com/photo-1513558161293-cdaf765ed2fd?auto=format&fit=crop&w=600&q=80';
        
        // 5. MULE (CANECA)
        if(n.includes('mule') || n.includes('moscow')) 
            return 'https://images.unsplash.com/photo-1530991037531-51dc55647a8f?auto=format&fit=crop&w=600&q=80';
        
        // 6. AZUL
        if(n.includes('blue') || n.includes('lagoa') || n.includes('c√©u')) 
            return 'https://images.unsplash.com/photo-1536935338788-843bb63194f5?auto=format&fit=crop&w=600&q=80';
        
        // 7. WHISKY / ESCURO
        if(n.includes('whisky') || n.includes('old') || n.includes('negave')) 
            return 'https://images.unsplash.com/photo-1527281400683-1abc8b4336a5?auto=format&fit=crop&w=600&q=80';
        
        // 8. APEROL / LARANJA
        if(n.includes('aperol') || n.includes('spritz') || n.includes('p√¥r do sol')) 
            return 'https://images.unsplash.com/photo-1560963689-0989366e6c0f?auto=format&fit=crop&w=600&q=80';

        // 9. DEFAULT (GEN√âRICO BONITO)
        return 'https://images.unsplash.com/photo-1470337458703-46ad1756a187?auto=format&fit=crop&w=600&q=80';
    }

    function renderizarCardapio() {
        document.getElementById('nomeEvento').innerText = DADOS_EVENTO.nome;
        const lista = document.getElementById('listaCardapio');
        lista.innerHTML = '';
        let esgotado = false;
        if(DADOS_EVENTO.tipo_servico === 'pacote' && DADOS_EVENTO.total_consumido >= DADOS_EVENTO.total_contratado) esgotado = true;

        const classicos = DADOS_EVENTO.cardapio.filter(d => d.categoria === 'classico');
        const premiums = DADOS_EVENTO.cardapio.filter(d => d.categoria === 'premium');

        const renderGrupo = (titulo, items) => {
            if(items.length === 0) return '';
            let html = `<div class="section-title">${titulo}</div>`;
            items.forEach(item => {
                let disponivel = item.disponivel !== false;
                let precoFinal = item.preco || 0;
                let htmlPreco = '';
                let imagemUrl = getDrinkImage(item.nome);
                
                if(DADOS_EVENTO.modo_preco === 'prevenda' && item.preco_prevenda) {
                    precoFinal = item.preco_prevenda;
                    htmlPreco = `
                        <div class="price-tag-container">
                            <span class="price-old">No dia: R$ ${item.preco}</span>
                            <span class="price-now">R$ ${item.preco_prevenda}</span>
                        </div>
                    `;
                } else {
                    if(item.tipo_cobranca === 'pago') {
                        htmlPreco = `<div class="price-tag-container"><span class="price-now">R$ ${item.preco}</span></div>`;
                    }
                }

                let isPaid = item.tipo_cobranca === 'pago' || esgotado;
                if(DADOS_EVENTO.tipo_servico === 'tradicional' && item.tipo_cobranca === 'pacote') isPaid = false;

                let btnHtml = '';
                let classeExtra = item.categoria === 'premium' ? 'premium-style' : '';
                
                if(!disponivel) { 
                    btnHtml = `<button class="btn-action btn-blocked" disabled>üö´ INDISPON√çVEL</button>`; 
                    classeExtra += ' esgotado'; 
                }
                else if(isPaid) { 
                    btnHtml = `<button class="btn-action btn-paid" onclick="abrirConfirmacao('${item.nome}', 'extra', ${precoFinal})">üõí COMPRAR</button>`; 
                }
                else { 
                    btnHtml = `<button class="btn-action btn-free" onclick="abrirConfirmacao('${item.nome}', 'pacote', 0)">üÜì PEGAR DO PACOTE</button>`; 
                }

                html += `
                <div class="drink-card ${classeExtra}">
                    <div class="card-image-box">
                        <img src="${imagemUrl}" class="card-image" loading="lazy">
                        <div class="card-image-overlay"></div>
                        ${htmlPreco}
                    </div>
                    <div class="drink-content">
                        <h3 class="drink-title">${item.nome}</h3>
                        <p class="drink-desc">${item.desc || 'Um drink delicioso e refrescante.'}</p>
                        ${btnHtml}
                    </div>
                </div>`;
            });
            return html;
        };
        lista.innerHTML += renderGrupo('ü•É Cl√°ssicos da Casa', classicos);
        lista.innerHTML += renderGrupo('üíé Drinks Premium', premiums);
    }

    // --- FUN√á√ïES DE INTERFACE (MANTER IGUAL) ---
    function mudarAba(aba) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        if(aba === 'pedidos') {
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            document.getElementById('tab-pedidos').classList.add('active');
        } else {
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            document.getElementById('tab-chat').classList.add('active');
            document.getElementById('alertChatTab').style.display = 'none';
            rolarChat();
        }
    }

    function enviarMensagem() {
        const txt = document.getElementById('chatInput').value;
        if(!txt.trim()) return;
        db.collection("chat_mensagens").add({ evento_id: EVENTO_ID, nome: NOME_CONVIDADO, mensagem: txt, remetente: 'cliente', data: new Date() });
        document.getElementById('chatInput').value = '';
    }

    function carregarChat() {
        db.collection("chat_mensagens").where("evento_id", "==", EVENTO_ID).where("nome", "==", NOME_CONVIDADO).onSnapshot((snapshot) => {
            const div = document.getElementById('chatMessages');
            div.innerHTML = '';
            let msgs = [];
            snapshot.forEach(doc => msgs.push(doc.data()));
            msgs.sort((a,b) => a.data - b.data);
            msgs.forEach(m => {
                const hora = m.data.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                const classe = m.remetente === 'cliente' ? 'msg-mine' : 'msg-admin';
                div.innerHTML += `<div class="msg ${classe}">${m.mensagem}<span class="msg-time">${hora}</span></div>`;
            });
            rolarChat();
            if(msgs.length > 0 && msgs[msgs.length-1].remetente === 'admin' && !document.getElementById('tab-chat').classList.contains('active')) {
                document.getElementById('alertChatTab').style.display = 'block';
            }
        });
    }
    function rolarChat() { setTimeout(() => { const d = document.getElementById('chatMessages'); d.scrollTop = d.scrollHeight; }, 100); }

    function salvarZap() {
        const zap = document.getElementById('mktZap').value;
        if(!zap) return alert("Digite o n√∫mero!");
        db.collection("clientes_marketing").add({ nome: NOME_CONVIDADO, whatsapp: zap, evento_id: EVENTO_ID, data: new Date() });
        alert("Salvo!");
    }

    function rastrearPedidos() {
        if(MEUS_PEDIDOS_IDS.length === 0) return;
        db.collection("pedidos").where("evento_id", "==", EVENTO_ID).where("nome_convidado", "==", NOME_CONVIDADO).onSnapshot((snapshot) => {
            const listaHTML = document.getElementById('listaMeusPedidosHTML'); listaHTML.innerHTML = ''; let contagemAtivos = 0;
            let pedidos = [];
            snapshot.forEach(doc => pedidos.push({id:doc.id, ...doc.data()}));
            pedidos.sort((a,b) => b.data - a.data);
            pedidos.forEach(p => {
                let statusText = "Fila", cor = "#888", extraHTML = "";
                let podeCancelar = true;
                if(p.status === 'pendente') { statusText = "üü° Preparando"; cor = "#FFD580"; contagemAtivos++; podeCancelar = false; }
                else if(p.status === 'aguardando_pagamento') { 
                    statusText = "üî¥ Aguardando Pagto"; cor = "#FF4444"; contagemAtivos++; 
                    if(!p.sinalizou_pagamento) extraHTML += `<button class="btn-client-action btn-i-paid" style="background:#4CAF50; color:white; border:none;" onclick="avisarPagamento('${p.id}')">‚úÖ J√Å FIZ O PIX</button>`;
                    else extraHTML += `<span class="payment-alert" style="color:#FFD580; border-color:#FFD580;">‚åõ Verificando...</span>`;
                }
                else if(p.status === 'pagamento_rejeitado') { statusText = "‚ùå Pix N√£o Achado"; cor = "#FF4444"; extraHTML += `<span class="payment-alert">O caixa n√£o achou o Pix.</span>`; }
                else if(p.status === 'servido') { statusText = "üü¢ Pronto!"; cor = "#4CAF50"; verificarAlertaPronto(p.id, p.status); podeCancelar = false; }
                else if(p.status === 'cancelado') { statusText = "‚ùå Cancelado"; cor = "#555"; podeCancelar = false; }
                if(podeCancelar) extraHTML += `<button class="btn-client-action btn-client-cancel" onclick="cancelarPedidoCliente('${p.id}')">Cancelar Pedido</button>`;
                listaHTML.innerHTML += `<div class="my-order-item" style="border-left-color:${cor}"><strong>${p.drink}</strong><span style="float:right; color:${cor}; font-weight:bold;">${statusText}</span><br><small style="color:#aaa;">${p.data.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</small>${extraHTML}</div>`;
            });
            const btn = document.getElementById('btnMeusPedidos');
            if(snapshot.size > 0) { btn.style.display = 'flex'; document.getElementById('badgeMeusPedidos').innerText = contagemAtivos; } else { btn.style.display = 'none'; }
        });
    }

    function avisarPagamento(id) { if(confirm("Confirma?")) { db.collection("pedidos").doc(id).update({ sinalizou_pagamento: true }); } }
    function cancelarPedidoCliente(id) { if(confirm("Cancelar?")) { db.collection("pedidos").doc(id).update({ status: 'cancelado' }); } }
    let pedidosNotificados = []; 
    function verificarAlertaPronto(id, status) { if(status === 'servido' && !pedidosNotificados.includes(id)) { if(navigator.vibrate) navigator.vibrate([200, 100, 200]); confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); document.getElementById('modalPronto').style.display = 'flex'; pedidosNotificados.push(id); } }
    
    function abrirConfirmacao(nome, tipo, preco) {
        if(tipo === 'pacote') { const restante = getTempoRestante(); if(restante > 0) return alert(`Aguarde ${Math.ceil(restante/60)} minutos.`); }
        ITEM_ATUAL = { nome, tipo, preco };
        document.getElementById('inputObservacao').value = '';
        const div = document.getElementById('conteudoConfirmacao');
        if(tipo === 'extra') {
            div.innerHTML = `<p style="color:#ddd">Voc√™ pediu: <strong>${nome}</strong></p><div class="pix-area"><span style="display:block; color:#aaa; font-size:0.8em;">Valor:</span><strong style="font-size:1.5em; color:#4CAF50;">R$ ${preco},00</strong><hr style="border-color:#444;"><span style="display:block; color:#aaa; font-size:0.8em; margin-top:10px;">Chave PIX:</span><span class="pix-key" id="chavePixTexto">${DADOS_EVENTO.chave_pix || "No balc√£o"}</span><button style="background:#444; color:#fff; border:none; padding:5px; width:100%; border-radius:5px;" onclick="copiarPix()">Copiar Chave</button></div><p style="font-size:0.8em; color:#FF4444;">‚ö†Ô∏è Realize o pagamento para iniciar o preparo.</p>`;
            document.getElementById('btnFinalizar').innerText = "J√Å PAGUEI / ENVIAR";
        } else {
            div.innerHTML = `<p style="color:#ddd">Pedir <strong>${nome}</strong>?</p>`;
            document.getElementById('btnFinalizar').innerText = "CONFIRMAR";
        }
        document.getElementById('modalConfirm').style.display = 'flex';
    }

    document.getElementById('btnFinalizar').onclick = function() {
        const btn = this; btn.innerText = "..."; btn.disabled = true;
        const obs = document.getElementById('inputObservacao').value;
        let statusInicial = ITEM_ATUAL.tipo === 'extra' ? 'aguardando_pagamento' : 'pendente';
        db.collection("pedidos").add({ evento_id: EVENTO_ID, drink: ITEM_ATUAL.nome, tipo: ITEM_ATUAL.tipo, preco: ITEM_ATUAL.preco, nome_convidado: NOME_CONVIDADO || "An√¥nimo", observacao: obs, status: statusInicial, sinalizou_pagamento: false, data: new Date() }).then((docRef) => {
            document.getElementById('modalConfirm').style.display = 'none'; btn.disabled = false; btn.innerText = "CONFIRMAR";
            if(ITEM_ATUAL.tipo === 'pacote') salvarTimer();
            MEUS_PEDIDOS_IDS.push(docRef.id); localStorage.setItem(`pedidos_${EVENTO_ID}`, JSON.stringify(MEUS_PEDIDOS_IDS)); rastrearPedidos();
            setTimeout(abrirMeusPedidos, 500);
        });
    }

    function abrirMeusPedidos() { document.getElementById('modalListaPedidos').style.display='flex'; }
    function salvarNome() { const val = document.getElementById('inputNomeConvidado').value; if(!val) return; NOME_CONVIDADO = val; localStorage.setItem('nome_usuario_gil', val); document.getElementById('modalNome').style.display = 'none'; document.getElementById('displayNome').innerText = val; rastrearPedidos(); carregarChat(); }
    function copiarPix() { navigator.clipboard.writeText(document.getElementById('chavePixTexto').innerText); alert("Copiado!"); }
    function salvarTimer() { localStorage.setItem(`timer_${EVENTO_ID}`, new Date().getTime()); verificarTimer(); }
    function getTempoRestante() { const last = localStorage.getItem(`timer_${EVENTO_ID}`); if(!last) return 0; const diff = new Date().getTime() - parseInt(last); const limit = TIMER_MINUTOS * 60000; return diff < limit ? (limit - diff)/1000 : 0; }
    function verificarTimer() { const restante = getTempoRestante(); document.querySelectorAll('.btn-pacote').forEach(btn => { if(restante > 0) { btn.disabled = true; btn.classList.add('btn-blocked'); btn.classList.remove('btn-free'); btn.innerHTML = `‚è≥ Aguarde ${Math.ceil(restante/60)} min`; } else { btn.disabled = false; btn.classList.remove('btn-blocked'); btn.classList.add('btn-free'); btn.innerHTML = `üÜì Pedir`; } }); if(restante > 0) setTimeout(verificarTimer, 5000); }
    function mostrarNotificacao(t) { const n = document.getElementById('notification'); n.innerText=t; n.style.display='block'; setTimeout(()=>n.style.display='none',4000); }
</script>
</body>
</html>
