<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurar Evento - Gil Eventos</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #121212; color: #EAEAEA; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        h1 { color: #FFD580; text-align: center; text-transform: uppercase; letter-spacing: 2px; }
        .card { background: #1E1E1E; padding: 25px; border-radius: 15px; border: 1px solid #333; margin-bottom: 20px; }
        label { display: block; margin-top: 15px; color: #FFD580; font-size: 0.9em; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; background: #2A2A2A; border: 1px solid #444; color: #fff; border-radius: 8px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; background: linear-gradient(90deg, #FF6700, #FF9500); border: none; color: white; font-weight: bold; border-radius: 8px; margin-top: 25px; cursor: pointer; transition: 0.3s; }
        .drink-item { background: #252525; border: 1px solid #444; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .drink-header { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .input-nome { flex: 2; }
        .configs-row { display: flex; gap: 10px; margin-top: 10px; background: #1a1a1a; padding: 10px; border-radius: 8px; align-items: flex-end; flex-wrap: wrap; }
        .config-group { flex: 1; min-width: 120px; }
        .config-label { font-size: 0.75em; color: #888; margin-bottom: 3px; display: block; }
        .select-mini { width: 100%; padding: 8px; font-size: 0.9em; border: 1px solid #555; }
        .btn-add { background: #333; border: 1px dashed #777; color: #aaa; width: 100%; padding: 15px; border-radius: 10px; cursor: pointer; margin-top: 10px; }
        .row { display: flex; gap: 10px; } .col { flex: 1; }
    </style>
</head>
<body>
<div class="container">
    <h1 id="tituloPagina">Novo Evento ‚öôÔ∏è</h1>
    <div class="card">
        <label>Nome do Evento</label>
        <input type="text" id="nomeEvento" placeholder="Ex: Casamento Ana">
        
        <div class="row">
            <div class="col">
                <label>Modelo do Contrato</label>
                <select id="tipoServico" onchange="togglePacote()">
                    <option value="pacote">üì¶ Pacote Fechado</option>
                    <option value="tradicional">üçπ Tradicional (Open)</option>
                </select>
            </div>
            <div class="col" id="boxQuantidade">
                <label>Limite Total (Drinks)</label>
                <input type="number" id="qtdPacote" placeholder="Ex: 300">
            </div>
        </div>

        <label>Chave PIX (Para vendas)</label>
        <input type="text" id="chavePix" placeholder="E-mail ou CPF">

        <label style="margin-top:25px; border-top:1px solid #333; padding-top:15px;">Card√°pio, Pre√ßos & Pr√©-venda</label>
        <small style="color:#FFD580; margin-bottom:10px; display:block;">‚ö†Ô∏è IMPORTANTE: O pre√ßo "Normal" √© o do dia. O "Pr√©-venda" √© para vendas antecipadas.</small>
        
        <div id="listaDrinksEditor"></div>
        <button class="btn-add" onclick="adicionarNovoDrink()">+ ADICIONAR NOVO DRINK</button>

        <label>Timer de Bloqueio (minutos)</label>
        <input type="number" id="timerBloqueio" value="15">

        <label>Senha Admin</label>
        <input type="text" id="senhaAdmin" placeholder="Senha mestre">

        <button class="btn" id="btnSalvar" onclick="salvarEvento()">CRIAR EVENTO</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDLPi5Mf6_9ypigmf3v9Qe9YYPUr1mfaHk",
        authDomain: "gil-eventos-app-911fe.firebaseapp.com",
        projectId: "gil-eventos-app-911fe",
        storageBucket: "gil-eventos-app-911fe.firebasestorage.app",
        messagingSenderId: "503025880352",
        appId: "1:503025880352:web:694b7f2889cff501c7db45",
        measurementId: "G-3DZ1P5C0M3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const params = new URLSearchParams(window.location.search);
    const EVENTO_ID = params.get('evento');

    // Menu Padr√£o (s√≥ usado se for evento novo)
    let cardapioAtual = [
        { nome: "Elixir do Sol", desc: "Abacaxi, hortel√£ e especiarias.", categoria: "classico", tipo_cobranca: "pacote", preco: 15, preco_prevenda: 12 },
        { nome: "Caipirinha", desc: "Lim√£o e cacha√ßa.", categoria: "classico", tipo_cobranca: "pacote", preco: 12, preco_prevenda: 10 },
        { nome: "Gin Tropical", desc: "Gin e energ√©tico.", categoria: "premium", tipo_cobranca: "pago", preco: 25, preco_prevenda: 20 }
    ];

    // VERIFICA SE √â EDI√á√ÉO
    if(EVENTO_ID) {
        document.getElementById('tituloPagina').innerText = "Editar Evento ‚úèÔ∏è";
        document.getElementById('btnSalvar').innerText = "SALVAR ALTERA√á√ïES";
        carregarDadosEdicao();
    } else {
        renderizarEditor();
    }

    function carregarDadosEdicao() {
        db.collection("eventos").doc(EVENTO_ID).get().then((doc) => {
            if(doc.exists) {
                const dados = doc.data();
                document.getElementById('nomeEvento').value = dados.nome;
                document.getElementById('tipoServico').value = dados.tipo_servico;
                document.getElementById('qtdPacote').value = dados.total_contratado;
                document.getElementById('chavePix').value = dados.chave_pix || "";
                document.getElementById('timerBloqueio').value = dados.timer_minutos;
                document.getElementById('senhaAdmin').value = dados.senha_admin;
                
                cardapioAtual = dados.cardapio || [];
                togglePacote();
                renderizarEditor();
            }
        });
    }

    function renderizarEditor() {
        const container = document.getElementById('listaDrinksEditor');
        container.innerHTML = '';
        cardapioAtual.forEach((drink, index) => {
            const div = document.createElement('div');
            div.className = 'drink-item';
            
            // Garante que o campo pr√©-venda exista
            const precoPrevenda = drink.preco_prevenda || drink.preco || 0;

            div.innerHTML = `
                <div class="drink-header">
                    <input type="text" value="${drink.nome}" class="input-nome" placeholder="Nome">
                    <button style="background:#ff4444; border:none; color:white; border-radius:5px; padding:5px 10px; cursor:pointer;" onclick="removerDrink(${index})">üóëÔ∏è</button>
                </div>
                <textarea rows="2" class="input-desc" placeholder="Descri√ß√£o">${drink.desc}</textarea>
                
                <div class="configs-row">
                    <div class="config-group">
                        <span class="config-label">CATEGORIA</span>
                        <select class="select-mini input-cat">
                            <option value="classico" ${drink.categoria==='classico'?'selected':''}>ü•É Cl√°ssico</option>
                            <option value="premium" ${drink.categoria==='premium'?'selected':''}>üíé Premium</option>
                        </select>
                    </div>
                    <div class="config-group">
                        <span class="config-label">CONTRATO</span>
                        <select class="select-mini input-cob">
                            <option value="pacote" ${drink.tipo_cobranca==='pacote'?'selected':''}>üÜì Pacote</option>
                            <option value="pago" ${drink.tipo_cobranca==='pago'?'selected':''}>üí≤ Pago</option>
                        </select>
                    </div>
                    <div class="config-group">
                        <span class="config-label">R$ PR√â-VENDA</span>
                        <input type="number" value="${precoPrevenda}" class="input-preco-prevenda select-mini" placeholder="R$ Antecipado">
                    </div>
                    <div class="config-group">
                        <span class="config-label">R$ NO DIA</span>
                        <input type="number" value="${drink.preco}" class="input-preco select-mini" placeholder="R$ Normal">
                    </div>
                </div>`;
            container.appendChild(div);
        });
    }

    function adicionarNovoDrink() { cardapioAtual.push({ nome: "", desc: "", categoria: "classico", tipo_cobranca: "pacote", preco: 0, preco_prevenda: 0 }); renderizarEditor(); }
    function removerDrink(index) { cardapioAtual.splice(index, 1); renderizarEditor(); }
    
    function togglePacote() {
        const tipo = document.getElementById('tipoServico').value;
        const box = document.getElementById('boxQuantidade');
        box.style.display = (tipo === 'tradicional') ? 'none' : 'block';
        if(tipo === 'tradicional') document.getElementById('qtdPacote').value = 999999;
    }

    function salvarEvento() {
        const nome = document.getElementById('nomeEvento').value;
        const tipo = document.getElementById('tipoServico').value;
        const qtd = parseInt(document.getElementById('qtdPacote').value) || 0;
        const pix = document.getElementById('chavePix').value || "N√£o informada";
        const timer = parseInt(document.getElementById('timerBloqueio').value);
        const senha = document.getElementById('senhaAdmin').value;
        
        let cardapioFinal = [];
        document.querySelectorAll('.drink-item').forEach(item => {
            cardapioFinal.push({
                nome: item.querySelector('.input-nome').value,
                desc: item.querySelector('.input-desc').value,
                categoria: item.querySelector('.input-cat').value,
                tipo_cobranca: item.querySelector('.input-cob').value,
                preco: parseFloat(item.querySelector('.input-preco').value) || 0,
                preco_prevenda: parseFloat(item.querySelector('.input-preco-prevenda').value) || 0,
                disponivel: true // Reseta disponibilidade ao salvar (opcional)
            });
        });

        if(!nome || !senha) return alert("Preencha campos obrigat√≥rios!");

        const btn = document.getElementById('btnSalvar');
        btn.innerText = "Salvando..."; btn.disabled = true;

        const dadosEvento = {
            nome: nome,
            tipo_servico: tipo,
            total_contratado: qtd,
            chave_pix: pix,
            timer_minutos: timer,
            senha_admin: senha,
            cardapio: cardapioFinal,
            // N√£o sobrescrevemos contadores se for edi√ß√£o
        };

        if(EVENTO_ID) {
            // ATUALIZAR (MERGE)
            db.collection("eventos").doc(EVENTO_ID).update(dadosEvento).then(() => {
                alert("Evento atualizado com sucesso!");
                window.location.href = `dashboard.html?evento=${EVENTO_ID}`;
            });
        } else {
            // CRIAR NOVO (Adiciona campos iniciais)
            dadosEvento.total_consumido = 0;
            dadosEvento.total_vendas_extra = 0;
            dadosEvento.total_faturamento = 0;
            dadosEvento.ativo = true;
            dadosEvento.data_criacao = new Date();
            dadosEvento.modo_preco = 'normal'; // Padr√£o: pre√ßo normal

            db.collection("eventos").add(dadosEvento).then((docRef) => {
                window.location.href = `dashboard.html?evento=${docRef.id}`;
            });
        }
    }
    togglePacote();
</script>
</body>
</html>
