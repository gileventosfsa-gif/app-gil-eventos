<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torre de Controle - Gil Eventos</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #121212; color: #fff; margin: 0; padding: 20px; overflow-x: hidden; }
        
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        h1 { margin: 0; color: #FFD580; font-size: 1.5em; }
        .badge-event { background: #333; padding: 5px 10px; border-radius: 4px; font-size: 0.8em; margin-left: 10px; vertical-align: middle; }

        .grid-layout { display: grid; grid-template-columns: 300px 1fr 300px; gap: 20px; height: calc(100vh - 100px); }
        .col-commands { display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .col-queue { background: #181818; border-radius: 12px; padding: 15px; border: 1px solid #333; display: flex; flex-direction: column; }
        .col-history { background: #151515; border-radius: 12px; padding: 15px; overflow-y: auto; border: 1px solid #222; }

        .card-box { background: #1E1E1E; padding: 20px; border-radius: 12px; border: 1px solid #333; position: relative; }
        .big-stat { font-size: 2em; font-weight: 800; color: #4CAF50; }
        .label { color: #888; font-size: 0.8em; text-transform: uppercase; margin-bottom: 5px; }
        
        .btn-drink { width: 100%; padding: 12px; background: #333; border: 1px solid #555; color: #fff; margin-bottom: 8px; border-radius: 6px; cursor: pointer; text-align: left; transition: 0.2s; }
        .btn-drink:hover { background: #FFD580; color: #000; border-color: #FFD580; }
        
        /* ESTILO DOS CARDS DE PEDIDO */
        .order-card { background: #222; border-left: 5px solid #888; border-radius: 8px; padding: 15px; margin-bottom: 15px; animation: slideIn 0.3s; position: relative; }
        .order-card.extra { border-left-color: #FFD580; background: #2A2210; } 
        .order-card.pacote { border-left-color: #4CAF50; } 
        .order-card.pagamento { border-left-color: #FF4444; background: #2a1010; border: 1px dashed #FF4444; }
        .actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-ok { flex: 2; background: #2E7D32; border: none; padding: 10px; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; }
        .btn-pay { flex: 2; background: #FFD580; border: none; padding: 10px; border-radius: 5px; color: #000; cursor: pointer; font-weight: bold; }
        .btn-cancel { flex: 1; background: transparent; border: 1px solid #D32F2F; padding: 10px; border-radius: 5px; color: #D32F2F; cursor: pointer; }

        /* CONTROLE DE SOM */
        .sound-control { display: flex; align-items: center; gap: 10px; background: #222; padding: 5px 15px; border-radius: 30px; border: 1px solid #444; }
        input[type=range] { width: 80px; accent-color: #FFD580; }

        /* MODAIS */
        #loginOverlay, #eyeAuthOverlay, #qrOverlay, #stockOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #eyeAuthOverlay, #qrOverlay, #stockOverlay { display: none; }
        .login-box { text-align: center; background: #222; padding: 30px; border-radius: 15px; border: 1px solid #444; min-width: 300px; }
        .btn-top { background: #444; color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-left: 5px; }
        
        /* LISTA DE ESTOQUE */
        .stock-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #333; }
        .stock-item span { font-weight: bold; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4CAF50; }
        input:checked + .slider:before { transform: translateX(26px); }

        @media (max-width: 1000px) { .grid-layout { grid-template-columns: 1fr; height: auto; } .col-commands, .col-queue, .col-history { height: 500px; margin-bottom: 20px; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <audio id="somAlerta" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div id="loginOverlay"><div class="login-box"><h1 style="margin-bottom:20px;">üîí √Årea Restrita</h1><input type="password" id="senhaInput" placeholder="Senha" style="padding:10px; border-radius:5px;"><br><br><button class="btn-top" style="background:#FFD580; color:black;" onclick="verificarSenha()">ACESSAR</button><p id="erroSenha" style="color:red; display:none; margin-top:10px;">Senha Incorreta!</p></div></div>
    
    <div id="stockOverlay"><div class="login-box" style="width: 400px; max-height: 80vh; overflow-y: auto;">
        <h2 style="color:#FFD580;">Gerenciar Card√°pio</h2>
        <p style="color:#aaa; font-size:0.9em; margin-bottom:20px;">Pause drinks que acabaram.</p>
        <div id="listaEstoque"></div>
        <button onclick="document.getElementById('stockOverlay').style.display='none'" class="btn-top" style="margin-top:20px; width:100%;">FECHAR</button>
    </div></div>

    <div id="eyeAuthOverlay"><div class="login-box"><h3>üëÅÔ∏è Senha</h3><input type="password" id="senhaEyeInput"><br><br><button class="btn-top" onclick="confirmarSenhaEye()">VER</button><button onclick="document.getElementById('eyeAuthOverlay').style.display='none'" class="btn-top" style="background:transparent; border:1px solid #555;">Cancelar</button></div></div>
    <div id="qrOverlay"><div class="login-box"><h2 style="color:#FFD580;">üì≤ QR Code</h2><div id="qrcodeDisplay" style="background:white; padding:15px; border-radius:10px; display:inline-block; margin:20px 0;"></div><br><button onclick="document.getElementById('qrOverlay').style.display='none'" class="btn-top">Fechar</button></div></div>

    <div class="header">
        <div><span id="nomeEvento">Carregando...</span><span class="badge-event" id="tipoEvento">...</span></div>
        <div class="sound-control">
            <span style="font-size:1.2em;">üîä</span>
            <input type="range" min="0" max="1" step="0.1" value="1" onchange="mudarVolume(this.value)">
        </div>
        <div>
            <button onclick="abrirEstoque()" class="btn-top" style="background:#2196F3;">üì¶ Estoque</button>
            <button onclick="mostrarQR()" class="btn-top">üì± QR Code</button>
            <button onclick="window.close()" class="btn-top" style="background:transparent; border:1px solid #555; color:#888;">Sair</button>
        </div>
    </div>

    <div class="grid-layout">
        <div class="col-commands">
            <div class="card-box"><div class="label">Consumo Pacote</div><div class="big-stat"><span id="consumido">0</span> <span style="font-size:0.5em; color:#666;">/ <span id="total">‚àû</span></span></div><div style="height:5px; background:#333; margin-top:5px;"><div id="progressoBar" style="height:100%; width:0%; background:#4CAF50;"></div></div></div>
            <div class="card-box"><button class="eye-btn" onclick="toggleFaturamento()">üëÅÔ∏è</button><div class="label">Faturamento</div><div class="big-stat" style="color:#FFD580;"><span id="valorFaturamento" style="filter:blur(5px);">R$ 0,00</span></div><div style="font-size:0.8em; color:#666;">Vendas: <span id="qtdVendasExtras">0</span></div></div>
            <div class="card-box"><div class="label">üìù Pedido Manual</div><div id="listaBotoesManual" style="margin-top:10px;"></div></div>
        </div>
        <div class="col-queue"><div class="queue-header"><span>üî• Fila / Caixa</span><span style="font-size:0.8em; background:#FF4444; padding:2px 8px; border-radius:10px; color:white;" id="qtdFila">0</span></div><div class="queue-list" id="listaFila"></div></div>
        <div class="col-history"><div class="queue-header">üìú Hist√≥rico</div><div id="listaHistorico"></div></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDLPi5Mf6_9ypigmf3v9Qe9YYPUr1mfaHk",
            authDomain: "gil-eventos-app-911fe.firebaseapp.com",
            projectId: "gil-eventos-app-911fe",
            storageBucket: "gil-eventos-app-911fe.firebasestorage.app",
            messagingSenderId: "503025880352",
            appId: "1:503025880352:web:694b7f2889cff501c7db45",
            measurementId: "G-3DZ1P5C0M3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const params = new URLSearchParams(window.location.search);
        const EVENTO_ID = params.get('evento');
        let DADOS_EVENTO = null;
        let FATURAMENTO_VISIVEL = false;
        let wakeLock = null;

        if(sessionStorage.getItem(`logado_${EVENTO_ID}`)) document.getElementById('loginOverlay').style.display = 'none';
        if(EVENTO_ID) iniciarTorreControle();

        async function requestWakeLock() { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }
        document.addEventListener('visibilitychange', async () => { if (wakeLock !== null && document.visibilityState === 'visible') requestWakeLock(); });

        function iniciarTorreControle() {
            requestWakeLock();
            db.collection("eventos").doc(EVENTO_ID).onSnapshot((doc) => {
                if(doc.exists){ 
                    DADOS_EVENTO = doc.data(); 
                    atualizarInterface(DADOS_EVENTO); 
                    gerarBotoes(DADOS_EVENTO.cardapio);
                    gerarListaEstoque(DADOS_EVENTO.cardapio);
                }
            });

            db.collection("pedidos").where("evento_id", "==", EVENTO_ID).where("status", "in", ["pendente", "aguardando_pagamento"]).onSnapshot((snapshot) => {
                const lista = document.getElementById('listaFila');
                document.getElementById('qtdFila').innerText = snapshot.size;
                snapshot.docChanges().forEach((change) => { if (change.type === "added") document.getElementById('somAlerta').play().catch(()=>{}); });
                lista.innerHTML = snapshot.empty ? '<div style="text-align:center; color:#555; margin-top:50px;">Vazio</div>' : '';
                snapshot.forEach(doc => {
                    const p = doc.data();
                    const hora = p.data.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    let classe='pacote', badge='üÜì PACOTE', btnHtml=`<button class="btn-ok" onclick="mudarStatus('${doc.id}', 'servido', 'pacote', 0)">‚úÖ PRONTO</button>`;
                    if(p.tipo === 'extra') {
                        if(p.status === 'aguardando_pagamento') { classe='pagamento'; badge=`üî¥ AGUARDANDO PGTO (R$ ${p.preco})`; btnHtml=`<button class="btn-pay" onclick="mudarStatus('${doc.id}', 'servido', 'extra', ${p.preco})">üí∞ CONFIRMAR</button>`; } 
                        else { classe='extra'; badge=`üí≤ PAGO (R$ ${p.preco})`; btnHtml=`<button class="btn-ok" onclick="mudarStatus('${doc.id}', 'servido', 'extra', ${p.preco})">‚úÖ PRONTO</button>`; }
                    }
                    lista.innerHTML += `<div class="order-card ${classe}"><div class="time">${hora}</div><div class="client">${p.nome_convidado}</div><div class="order-info"><h3>${p.drink}</h3><small style="background:rgba(0,0,0,0.3); padding:2px 5px; border-radius:3px;">${badge}</small></div><div class="actions"><button class="btn-cancel" onclick="mudarStatus('${doc.id}', 'cancelado')">‚úñ</button>${btnHtml}</div></div>`;
                });
            });

            db.collection("pedidos").where("evento_id", "==", EVENTO_ID).where("status", "in", ["servido", "cancelado"]).limit(30).onSnapshot((s) => { 
                const l = document.getElementById('listaHistorico'); l.innerHTML = ''; 
                s.forEach(doc => { const p = doc.data(); l.innerHTML += `<div class="hist-item"><div><strong style="color:#FFD580">${p.drink}</strong><br><span style="color:#666">${p.nome_convidado}</span></div><div style="text-align:right">${p.status}</div></div>`; }); 
            });
        }

        // --- ESTOQUE ---
        function abrirEstoque() { document.getElementById('stockOverlay').style.display = 'flex'; }
        function gerarListaEstoque(menu) {
            const div = document.getElementById('listaEstoque'); div.innerHTML = '';
            menu.forEach((item, index) => {
                const checked = item.disponivel !== false ? 'checked' : ''; // Default true
                div.innerHTML += `
                    <div class="stock-item">
                        <span>${item.nome}</span>
                        <label class="toggle-switch">
                            <input type="checkbox" ${checked} onchange="toggleDisponibilidade(${index})">
                            <span class="slider"></span>
                        </label>
                    </div>`;
            });
        }
        function toggleDisponibilidade(index) {
            let cardapio = DADOS_EVENTO.cardapio;
            // Se 'disponivel' n√£o existe, assume true, ent√£o inverte para false
            const atual = cardapio[index].disponivel !== false;
            cardapio[index].disponivel = !atual;
            db.collection("eventos").doc(EVENTO_ID).update({ cardapio: cardapio });
        }

        // --- SOM ---
        function mudarVolume(val) { document.getElementById('somAlerta').volume = val; }

        // --- OUTROS ---
        function verificarSenha() { if(document.getElementById('senhaInput').value === DADOS_EVENTO.senha_admin) { document.getElementById('loginOverlay').style.display = 'none'; sessionStorage.setItem(`logado_${EVENTO_ID}`, true); document.getElementById('somAlerta').play().catch(()=>{}); } else document.getElementById('erroSenha').style.display='block'; }
        function toggleFaturamento() { const el=document.getElementById('valorFaturamento'); if(FATURAMENTO_VISIVEL){el.style.filter='blur(5px)';FATURAMENTO_VISIVEL=false;}else{document.getElementById('eyeAuthOverlay').style.display='flex';document.getElementById('senhaEyeInput').focus();} }
        function confirmarSenhaEye() { if(document.getElementById('senhaEyeInput').value===DADOS_EVENTO.senha_admin){document.getElementById('eyeAuthOverlay').style.display='none';document.getElementById('valorFaturamento').style.filter='none';FATURAMENTO_VISIVEL=true;}else alert("Senha errada"); }
        function mostrarQR() { const url=window.location.href.replace('dashboard.html','index.html'); document.getElementById('qrcodeDisplay').innerHTML=''; new QRCode(document.getElementById("qrcodeDisplay"),{text:url,width:250,height:250}); document.getElementById('qrOverlay').style.display='flex'; }
        function copiarLink() { navigator.clipboard.writeText(window.location.href.replace('dashboard.html','index.html')); alert("Copiado!"); }
        function atualizarInterface(dados) { document.getElementById('nomeEvento').innerText = dados.nome; document.getElementById('consumido').innerText = dados.total_consumido; if(dados.tipo_servico === 'pacote') { document.getElementById('total').innerText = dados.total_contratado; document.getElementById('progressoBar').style.width = ((dados.total_consumido/dados.total_contratado)*100)+'%'; } document.getElementById('valorFaturamento').innerText = `R$ ${dados.total_faturamento.toFixed(2)}`; document.getElementById('qtdVendasExtras').innerText = dados.total_vendas_extra; }
        function gerarBotoes(menu) { const div = document.getElementById('listaBotoesManual'); div.innerHTML = ''; menu.forEach(item => { if(item.disponivel === false) return; const btn = document.createElement('button'); btn.className = item.is_premium ? 'btn-drink premium' : 'btn-drink'; btn.innerText = (item.is_premium?'üí≤ ':'üÜì ') + item.nome; btn.onclick = () => lancarManual(item); div.appendChild(btn); }); }
        function lancarManual(item) { if(!confirm(`Lan√ßar ${item.nome}?`)) return; let tipo = 'pacote'; if(item.tipo_cobranca === 'pago' || (DADOS_EVENTO.tipo_servico==='pacote' && DADOS_EVENTO.total_consumido >= DADOS_EVENTO.total_contratado)) tipo='extra'; db.collection("pedidos").add({ evento_id: EVENTO_ID, drink: item.nome, tipo: tipo, preco: item.preco||0, nome_convidado: "Balc√£o", status: 'pendente', data: new Date() }); }
        function mudarStatus(id, novoStatus, tipo, preco) { db.collection("pedidos").doc(id).update({ status: novoStatus }); if(novoStatus === 'servido') { if(tipo === 'pacote') db.collection("eventos").doc(EVENTO_ID).update({ total_consumido: firebase.firestore.FieldValue.increment(1) }); if(tipo === 'extra') db.collection("eventos").doc(EVENTO_ID).update({ total_vendas_extra: firebase.firestore.FieldValue.increment(1), total_faturamento: firebase.firestore.FieldValue.increment(preco) }); } }
    </script>
</body>
</html>
