<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Oficial - Gil Eventos</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #121212; color: #EAEAEA; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        .brand { color: #FF9500; letter-spacing: 2px; text-transform: uppercase; font-weight: bold; }
        .page-title { font-size: 1.5em; margin: 5px 0 0 0; color: #fff; }

        /* PAINEL DE CONTROLE (S√ì ADMIN) */
        #adminPanel { background: #1E1E1E; padding: 20px; border-radius: 12px; border: 1px solid #333; margin-bottom: 30px; display: none; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .full-width { grid-column: 1 / -1; }
        
        input, select { width: 100%; padding: 12px; background: #2A2A2A; border: 1px solid #444; color: #fff; border-radius: 8px; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        /* MULTI-NOTAS ESTILO */
        .notes-container { margin-top: 10px; background: #252525; padding: 10px; border-radius: 8px; }
        .note-input-row { display: flex; gap: 10px; margin-bottom: 8px; }
        .note-input-row input { flex: 1; }
        .btn-remove-note { background: #D32F2F; color: white; border: none; padding: 0 15px; border-radius: 5px; cursor: pointer; }
        .btn-add-note { background: #333; border: 1px dashed #777; color: #aaa; width: 100%; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: 0.2s; }
        .btn-add-note:hover { border-color: #FF9500; color: #FF9500; }

        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn-add { background: linear-gradient(90deg, #FF6700, #FF9500); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; flex: 2; }
        .btn-cancel-edit { background: #444; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; flex: 1; display: none; }

        /* LISTA DE AGENDAMENTOS */
        .event-card { background: #1a1a1a; border-left: 5px solid #555; padding: 20px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px; transition: 0.3s; position: relative; }
        .event-card:hover { transform: translateX(5px); background: #222; }
        
        .status-confirmado { border-left-color: #4CAF50; }
        .status-pendente { border-left-color: #FFD580; }
        .status-concluido { border-left-color: #888; opacity: 0.7; }

        .date-box { text-align: center; background: #252525; padding: 10px; border-radius: 8px; min-width: 70px; }
        .day { font-size: 1.5em; font-weight: bold; display: block; line-height: 1; color: #fff; }
        .month { font-size: 0.8em; text-transform: uppercase; color: #FF9500; display: block; margin-bottom: 5px; }
        .time { font-size: 0.85em; color: #ccc; background: #333; padding: 2px 5px; border-radius: 4px; display: block; }
        
        .info-box { flex-grow: 1; }
        .client-name { font-size: 1.2em; font-weight: bold; color: #fff; display: block; }
        .event-type { color: #aaa; font-size: 0.9em; font-weight: bold; margin-bottom: 5px; display: block; }
        
        /* ANOTA√á√ïES DO ADMIN (NA LISTA) */
        .admin-notes-list { margin-top: 10px; border-top: 1px dashed #444; padding-top: 5px; }
        .admin-note-tag { display: block; font-size: 0.85em; color: #FFD580; background: rgba(255, 213, 128, 0.1); padding: 4px 8px; border-radius: 4px; margin-top: 4px; }
        
        /* DADOS SENS√çVEIS */
        .sensitive-data { font-family: monospace; color: #4CAF50; background: rgba(76, 175, 80, 0.1); padding: 5px 10px; border-radius: 5px; font-size: 1.1em; display: inline-block; margin-top: 5px; }
        .blurred { filter: blur(6px); user-select: none; cursor: default; }

        .actions { display: flex; gap: 10px; align-items: center; margin-top: 5px; }
        .btn-icon { background: #333; border: 1px solid #555; color: #fff; padding: 8px 12px; border-radius: 5px; cursor: pointer; transition: 0.2s; text-decoration: none; display: inline-block; font-size: 0.9em; }
        .btn-icon:hover { background: #FF9500; color: #000; border-color: #FF9500; }
        .btn-danger { color: #FF4444; border-color: #FF4444; }
        .btn-danger:hover { background: #FF4444; color: white; }
        .btn-edit { color: #2196F3; border-color: #2196F3; }
        .btn-edit:hover { background: #2196F3; color: white; }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { text-align: center; }
        .btn-login { padding: 10px 30px; background: #FF9500; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-public { background: transparent; border: 1px solid #555; color: #aaa; margin-top: 20px; font-size: 0.8em; }

        @media (max-width: 600px) {
            .event-card { flex-direction: column; align-items: flex-start; }
            .date-box { display: flex; gap: 10px; align-items: center; width: 100%; justify-content: flex-start; background: transparent; padding: 0; margin-bottom: 0; }
            .time { display: inline-block; margin-left: 10px; }
            .actions { width: 100%; flex-wrap: wrap; }
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h1 style="color:#FF9500;">AGENDA GIL EVENTOS</h1>
            <p style="color:#ccc;">√Årea Administrativa</p>
            <input type="password" id="senhaInput" placeholder="Senha do Admin" style="text-align:center; width:200px;">
            <br>
            <button class="btn-login" onclick="logarAdmin()">ENTRAR</button>
            <p id="msgErro" style="color:red; display:none; margin-top:10px;">Senha Incorreta</p>
            <br>
            <button class="btn-login btn-public" onclick="entrarModoPublico()">Apenas Visualizar (Cliente)</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div>
                <span class="brand">GIL EVENTOS</span>
                <h2 class="page-title">Cronograma Oficial</h2>
            </div>
            <div id="adminControls" style="display:none;">
                <button class="btn-icon" onclick="toggleBlur()" title="Ocultar Valores">üëÅÔ∏è Ocultar Valores</button>
                <button class="btn-icon" onclick="toggleForm()">‚ûï Gerenciar</button>
            </div>
        </div>

        <div id="adminPanel">
            <h3 style="color:#FF9500; margin-top:0;" id="tituloForm">Novo Agendamento</h3>
            <div class="form-grid">
                <input type="text" id="novoCliente" placeholder="Nome do Cliente">
                <input type="date" id="novoData">
                <input type="time" id="novoHorario">
                <input type="text" id="novoTipo" placeholder="Tipo (Ex: Casamento)">
                <select id="novoStatus">
                    <option value="confirmado">Confirmado (Verde)</option>
                    <option value="pendente">Pendente (Amarelo)</option>
                    <option value="concluido">Conclu√≠do (Cinza)</option>
                </select>
                <input type="number" id="novoValor" placeholder="Valor (R$)">
                <input type="text" id="novoLink" placeholder="ID do Evento no Bar (Opcional)">
                
                <div class="full-width">
                    <label style="color:#888; font-size:0.9em;">Anota√ß√µes Internas (Cliente N√ÉO V√ä)</label>
                    <div class="notes-container" id="containerNotas">
                        </div>
                    <button class="btn-add-note" onclick="adicionarInputNota()">+ Nova Nota</button>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn-add" id="btnSalvarAgenda" onclick="salvarAgendamento()">SALVAR NA AGENDA</button>
                <button class="btn-cancel-edit" id="btnCancelarEdicao" onclick="cancelarEdicao()">CANCELAR EDI√á√ÉO</button>
            </div>
        </div>

        <div id="listaEventos"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDLPi5Mf6_9ypigmf3v9Qe9YYPUr1mfaHk",
            authDomain: "gil-eventos-app-911fe.firebaseapp.com",
            projectId: "gil-eventos-app-911fe",
            storageBucket: "gil-eventos-app-911fe.firebasestorage.app",
            messagingSenderId: "503025880352",
            appId: "1:503025880352:web:694b7f2889cff501c7db45",
            measurementId: "G-3DZ1P5C0M3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const SENHA_MESTRA = "9859"; 
        let IS_ADMIN = false;
        let HIDE_VALUES = false;
        let EDITING_ID = null;

        function logarAdmin() {
            const senha = document.getElementById('senhaInput').value;
            if(senha === SENHA_MESTRA) { 
                IS_ADMIN = true;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('adminControls').style.display = 'block';
                carregarAgenda();
            } else { 
                document.getElementById('msgErro').style.display = 'block';
                document.getElementById('senhaInput').value = '';
            }
        }

        function entrarModoPublico() {
            IS_ADMIN = false;
            document.getElementById('loginOverlay').style.display = 'none';
            carregarAgenda();
        }

        // --- SISTEMA DE NOTAS DIN√ÇMICAS ---
        function adicionarInputNota(valor = "") {
            const container = document.getElementById('containerNotas');
            const div = document.createElement('div');
            div.className = 'note-input-row';
            div.innerHTML = `
                <input type="text" class="input-nota-item" placeholder="Ex: Levar gelo extra..." value="${valor}">
                <button class="btn-remove-note" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(div);
        }

        function carregarAgenda() {
            const lista = document.getElementById('listaEventos');
            lista.innerHTML = '<p style="text-align:center; color:#555;">Carregando...</p>';

            db.collection("agendamentos").orderBy("data_evento", "asc").onSnapshot((snapshot) => {
                lista.innerHTML = '';
                if(snapshot.empty) { lista.innerHTML = '<p style="text-align:center; color:#777;">Nenhum evento agendado.</p>'; return; }

                snapshot.forEach(doc => {
                    const e = doc.data();
                    
                    const dataObj = new Date(e.data_evento + "T00:00:00");
                    const dia = dataObj.getDate().toString().padStart(2, '0');
                    const mes = dataObj.toLocaleString('pt-BR', { month: 'short' }).replace('.', '');
                    const horaDisplay = e.hora_evento ? `üïó ${e.hora_evento}` : '';

                    const valorDisplay = e.valor ? `R$ ${parseFloat(e.valor).toFixed(2)}` : 'R$ 0,00';
                    const classeBlur = HIDE_VALUES ? 'blurred' : '';
                    
                    // --- SEGURAN√áA DAS NOTAS ---
                    let notasHtml = '';
                    if(IS_ADMIN) {
                        // Verifica se tem notas novas (array) ou velha (string)
                        let arrayNotas = e.anotacoes || [];
                        if(e.observacao) arrayNotas.push(e.observacao); // Suporte legado

                        if(arrayNotas.length > 0) {
                            notasHtml = '<div class="admin-notes-list">';
                            arrayNotas.forEach(nota => {
                                notasHtml += `<span class="admin-note-tag">üîí ${nota}</span>`;
                            });
                            notasHtml += '</div>';
                        }
                    }
                    // ---------------------------

                    let botoesAdmin = '';
                    if(IS_ADMIN) {
                        let btnLink = e.link_id ? `<a href="dashboard.html?evento=${e.link_id}" target="_blank" class="btn-icon" style="background:#2196F3; border:none;">üîó Bar</a>` : '';
                        
                        const dadosJson = JSON.stringify(e).replace(/'/g, "&#39;");
                        
                        botoesAdmin = `
                            <div class="actions">
                                <span class="sensitive-data ${classeBlur}">${valorDisplay}</span>
                                ${btnLink}
                                <button class="btn-icon btn-edit" onclick='prepararEdicao("${doc.id}", ${dadosJson})'>‚úèÔ∏è</button>
                                <button class="btn-icon btn-danger" onclick="excluirEvento('${doc.id}')">üóëÔ∏è</button>
                            </div>
                        `;
                    } else {
                        botoesAdmin = `<span style="font-size:0.8em; color:#555; text-transform:uppercase; letter-spacing:1px;">${e.status}</span>`;
                    }

                    const html = `
                        <div class="event-card status-${e.status}">
                            <div class="date-box">
                                <span class="day">${dia}</span>
                                <span class="month">${mes}</span>
                                <span class="time">${horaDisplay}</span>
                            </div>
                            <div class="info-box">
                                <span class="client-name">${e.cliente}</span>
                                <span class="event-type">${e.tipo}</span>
                                ${notasHtml}
                            </div>
                            ${botoesAdmin}
                        </div>
                    `;
                    lista.innerHTML += html;
                });
            });
        }

        function salvarAgendamento() {
            const cliente = document.getElementById('novoCliente').value;
            const data = document.getElementById('novoData').value;
            const hora = document.getElementById('novoHorario').value;
            const tipo = document.getElementById('novoTipo').value;
            const status = document.getElementById('novoStatus').value;
            const valor = document.getElementById('novoValor').value;
            const link = document.getElementById('novoLink').value;
            
            // Coletar todas as notas
            let notasArr = [];
            document.querySelectorAll('.input-nota-item').forEach(inp => {
                if(inp.value.trim()) notasArr.push(inp.value.trim());
            });

            if(!cliente || !data) return alert("Preencha Nome e Data!");

            const dadosEvento = {
                cliente: cliente,
                data_evento: data,
                hora_evento: hora,
                tipo: tipo,
                status: status,
                valor: valor,
                link_id: link,
                anotacoes: notasArr // Salva como Array
            };

            const btn = document.getElementById('btnSalvarAgenda');
            btn.disabled = true;
            btn.innerText = "Salvando...";

            if(EDITING_ID) {
                db.collection("agendamentos").doc(EDITING_ID).update(dadosEvento).then(() => {
                    alert("Atualizado com sucesso!");
                    limparFormulario();
                });
            } else {
                db.collection("agendamentos").add(dadosEvento).then(() => {
                    alert("Agendado!");
                    limparFormulario();
                });
            }
        }

        function prepararEdicao(id, dados) {
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('novoCliente').value = dados.cliente;
            document.getElementById('novoData').value = dados.data_evento;
            document.getElementById('novoHorario').value = dados.hora_evento || '';
            document.getElementById('novoTipo').value = dados.tipo;
            document.getElementById('novoStatus').value = dados.status;
            document.getElementById('novoValor').value = dados.valor;
            document.getElementById('novoLink').value = dados.link_id || '';
            
            // Preenche as notas dinamicamente
            document.getElementById('containerNotas').innerHTML = '';
            let notasParaEditar = dados.anotacoes || [];
            if(dados.observacao) notasParaEditar.push(dados.observacao); // Legado
            
            if(notasParaEditar.length > 0) {
                notasParaEditar.forEach(n => adicionarInputNota(n));
            } else {
                adicionarInputNota(); // Adiciona um vazio se n√£o tiver nada
            }

            EDITING_ID = id;
            document.getElementById('tituloForm').innerText = "Editando Evento ‚úèÔ∏è";
            document.getElementById('btnSalvarAgenda').innerText = "ATUALIZAR";
            document.getElementById('btnSalvarAgenda').style.background = "#2196F3"; 
            document.getElementById('btnCancelarEdicao').style.display = "block";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function limparFormulario() {
            EDITING_ID = null;
            document.getElementById('novoCliente').value = '';
            document.getElementById('novoData').value = '';
            document.getElementById('novoHorario').value = '';
            document.getElementById('novoTipo').value = '';
            document.getElementById('novoValor').value = '';
            document.getElementById('novoLink').value = '';
            document.getElementById('containerNotas').innerHTML = ''; // Limpa notas
            
            document.getElementById('tituloForm').innerText = "Novo Agendamento";
            document.getElementById('btnSalvarAgenda').innerText = "SALVAR NA AGENDA";
            document.getElementById('btnSalvarAgenda').style.background = "linear-gradient(90deg, #FF6700, #FF9500)";
            document.getElementById('btnSalvarAgenda').disabled = false;
            document.getElementById('btnCancelarEdicao').style.display = "none";
        }

        function cancelarEdicao() { limparFormulario(); }
        function excluirEvento(id) { if(confirm("Apagar agendamento?")) db.collection("agendamentos").doc(id).delete(); }
        function toggleForm() { const p = document.getElementById('adminPanel'); p.style.display = p.style.display === 'none' ? 'block' : 'none'; if(p.style.display==='block' && document.getElementById('containerNotas').innerHTML==='') adicionarInputNota(); }
        function toggleBlur() { HIDE_VALUES = !HIDE_VALUES; carregarAgenda(); }
    </script>
</body>
</html>
