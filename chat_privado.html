<script>
        const firebaseConfig = { apiKey: "AIzaSyDLPi5Mf6_9ypigmf3v9Qe9YYPUr1mfaHk", authDomain: "gil-eventos-app-911fe.firebaseapp.com", projectId: "gil-eventos-app-911fe", storageBucket: "gil-eventos-app-911fe.firebasestorage.app", messagingSenderId: "503025880352", appId: "1:503025880352:web:694b7f2889cff501c7db45", measurementId: "G-3DZ1P5C0M3" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let MEU_NOME = "";
        let MINHA_SALA = "";

        // 1. ENTRAR NA SALA
        function entrarNoChat() {
            const nome = document.getElementById('inputNome').value.trim();
            const senha = document.getElementById('inputSenhaSala').value.trim();

            if(!nome || !senha) return alert("Preencha seu apelido e a senha da sala!");

            MEU_NOME = nome;
            MINHA_SALA = senha; 

            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'flex';
            document.getElementById('displaySala').innerText = senha;

            monitorarMensagens();
        }

        // 2. MONITORAR MENSAGENS (CORRIGIDO: ORDENAÃ‡ÃƒO LOCAL)
        function monitorarMensagens() {
            const area = document.getElementById('chatArea');
            
            // REMOVI O .orderBy("data") DO BANCO PARA NÃƒO TRAVAR
            db.collection("chat_secreto")
              .where("sala_id", "==", MINHA_SALA)
              .onSnapshot(snapshot => {
                  area.innerHTML = ''; 
                  
                  if(snapshot.empty) {
                      area.innerHTML = '<p style="text-align:center; color:#555; margin-top:50px;">Inicie a conversa... ðŸ”’</p>';
                      return;
                  }

                  // PEGA AS MENSAGENS E ORDENA NO JAVASCRIPT (MAIS SEGURO)
                  let mensagens = [];
                  snapshot.forEach(doc => {
                      mensagens.push(doc.data());
                  });

                  // Ordena: Antigas primeiro, Novas embaixo
                  mensagens.sort((a, b) => {
                      let dateA = a.data ? a.data.toDate() : new Date();
                      let dateB = b.data ? b.data.toDate() : new Date();
                      return dateA - dateB;
                  });

                  mensagens.forEach(m => {
                      const souEu = m.nome === MEU_NOME;
                      const classe = souEu ? 'msg-me' : 'msg-other';
                      const nomeDisplay = souEu ? '' : `<span class="sender-name">${m.nome}</span>`;
                      const hora = m.data ? m.data.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';

                      area.innerHTML += `
                        <div class="msg ${classe}">
                            ${nomeDisplay}
                            ${m.texto}
                            <span class="msg-info">${hora}</span>
                        </div>
                      `;
                  });

                  // Rolar para o final
                  area.scrollTop = area.scrollHeight;

                  // Toca som se houver mensagem nova (verificaÃ§Ã£o simples)
                  snapshot.docChanges().forEach(change => {
                      if (change.type === "added") {
                          const dados = change.doc.data();
                          // SÃ³ toca se nÃ£o fui eu quem mandei e se a mensagem Ã© recente (menos de 1 min)
                          const agora = new Date();
                          const msgData = dados.data ? dados.data.toDate() : new Date();
                          const diff = (agora - msgData) / 1000;

                          if(dados.nome !== MEU_NOME && diff < 60) {
                              document.getElementById('somMsg').play().catch(()=>{});
                          }
                      }
                  });
              });
        }

        // 3. ENVIAR MENSAGEM
        function enviarMensagem() {
            const input = document.getElementById('msgInput');
            const texto = input.value.trim();
            if(!texto) return;

            db.collection("chat_secreto").add({
                sala_id: MINHA_SALA, 
                nome: MEU_NOME,
                texto: texto,
                data: new Date()
            }).catch(err => {
                alert("Erro ao enviar: " + err);
                console.error(err);
            });

            input.value = '';
            input.focus();
        }

        // 4. APAGAR TUDO
        function apagarTudo() {
            if(!confirm("Tem certeza? Isso apagarÃ¡ a conversa para AMBOS para sempre.")) return;

            db.collection("chat_secreto").where("sala_id", "==", MINHA_SALA).get().then(snapshot => {
                const batch = db.batch();
                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                batch.commit().then(() => alert("Conversa apagada!"));
            });
        }
    </script>
