<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TORRE DE CONTROLE - Gil Eventos</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #121212; color: #fff; font-family: 'Poppins', sans-serif; text-align: center; padding: 20px; }
        .container { max-width: 500px; margin: auto; }
        
        /* BOT√ÉO DE PROVA (ESTILO NOVO) */
        .btn-prova {
            width: 100%;
            padding: 15px;
            background: #2962FF; /* Azul forte */
            color: white;
            font-weight: 800;
            border: 2px solid #2979FF;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 1.1em;
            text-transform: uppercase;
            box-shadow: 0 0 20px rgba(41, 98, 255, 0.5);
            animation: pulseBtn 2s infinite;
        }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        h1 { color: #FFD580; margin-bottom: 20px; margin-top: 0; }
        
        select { width: 100%; padding: 15px; border-radius: 10px; background: #222; color: #fff; border: 1px solid #444; font-size: 1.1em; margin-bottom: 15px; }
        
        .status-display { padding: 20px; background: #1E1E1E; border-radius: 15px; margin-bottom: 30px; border: 1px solid #333; }
        .status-label { font-size: 0.9em; color: #aaa; }
        .status-value { font-size: 2em; font-weight: 800; margin-top: 5px; display: block; }
        
        .grid-btn { display: flex; flex-direction: column; gap: 15px; }
        
        .btn { padding: 20px; font-size: 1.2em; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; color: #000; transition: transform 0.2s; text-transform: uppercase; }
        .btn:active { transform: scale(0.95); }
        
        .btn-abrir { background: #00E676; box-shadow: 0 0 15px rgba(0, 230, 118, 0.4); }
        .btn-pausar { background: #FFD600; box-shadow: 0 0 15px rgba(255, 214, 0, 0.4); }
        .btn-encerrar { background: #FF1744; color: #fff; box-shadow: 0 0 15px rgba(255, 23, 68, 0.4); }

        /* MODAL DE RELAT√ìRIO */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #1E1E1E; padding: 20px; border-radius: 15px; width: 90%; max-width: 500px; height: 80vh; display: flex; flex-direction: column; border: 1px solid #444; }
        .report-summary { background: #222; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 1px solid #444; }
        .report-list { flex-grow: 1; overflow-y: auto; background: #121212; padding: 10px; border-radius: 8px; border: 1px solid #333; text-align: left; }
        .report-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 8px 0; font-size: 0.85em; color: #ccc; }
        .report-header { font-weight: bold; color: #FFD580; margin-bottom: 10px; border-bottom: 2px solid #FFD580; padding-bottom: 5px; display: flex; justify-content: space-between; }
        
        .btn-fechar { background: #333; color: #fff; border: 1px solid #555; padding: 15px; width: 100%; margin-top: 10px; border-radius: 10px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        
        <button class="btn-prova" onclick="abrirRelatorio()">
            üìä Ver Extrato / Prova de Consumo
        </button>

        <h1>üéõÔ∏è Controle do Evento</h1>

        <label style="display:block; text-align:left; margin-bottom:5px; color:#aaa;">Selecione o Evento:</label>
        <select id="selectEvento" onchange="monitorarEvento()">
            <option value="">Carregando eventos...</option>
        </select>

        <div class="status-display">
            <span class="status-label">STATUS ATUAL:</span>
            <span id="displayStatus" class="status-value">...</span>
        </div>

        <div class="grid-btn">
            <button class="btn btn-abrir" onclick="mudarStatus('aberto')">üü¢ ABRIR BAR</button>
            <button class="btn btn-pausar" onclick="mudarStatus('pausado')">‚úã PAUSAR PEDIDOS</button>
            <button class="btn btn-encerrar" onclick="mudarStatus('encerrado')">üèÅ ENCERRAR EVENTO</button>
        </div>
        
        <p style="margin-top:30px; color:#555; font-size:0.8em;">
            Use o bot√£o azul no topo para mostrar o consumo ao cliente.
        </p>
    </div>

    <div id="modalRelatorio" class="modal-overlay">
        <div class="modal-box">
            <h2 style="color:#2979FF; margin-top:0;">Extrato do Pacote</h2>
            <p style="color:#aaa; font-size:0.8em; margin-bottom:15px;">Use isso para provar o consumo ao cliente.</p>
            
            <div class="report-summary">
                <div style="display:flex; justify-content:space-around;">
                    <div>
                        <small style="color:#888;">CONTRATADO</small><br>
                        <strong style="font-size:1.4em; color:#fff;" id="repContratado">0</strong>
                    </div>
                    <div style="border-right:1px solid #444;"></div>
                    <div>
                        <small style="color:#888;">CONSUMIDO</small><br>
                        <strong style="font-size:1.4em; color:#00E676;" id="repConsumido">0</strong>
                    </div>
                </div>
            </div>

            <div class="report-header">
                <span style="width: 50px;">HORA</span>
                <span style="flex: 1; margin-left: 10px;">CLIENTE / DRINK</span>
            </div>
            
            <div id="listaRelatorio" class="report-list">
                <p style="text-align:center; color:#555;">Carregando dados...</p>
            </div>

            <button class="btn-fechar" onclick="document.getElementById('modalRelatorio').style.display='none'">FECHAR</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyDLPi5Mf6_9ypigmf3v9Qe9YYPUr1mfaHk", authDomain: "gil-eventos-app-911fe.firebaseapp.com", projectId: "gil-eventos-app-911fe", storageBucket: "gil-eventos-app-911fe.firebasestorage.app", messagingSenderId: "503025880352", appId: "1:503025880352:web:694b7f2889cff501c7db45", measurementId: "G-3DZ1P5C0M3" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let eventoAtualID = "";
        let dadosEventoAtual = null;

        // 1. Carregar lista de eventos ativos
        db.collection("eventos").orderBy("data_criacao", "desc").get().then((snapshot) => {
            const select = document.getElementById("selectEvento");
            select.innerHTML = '<option value="">Selecione um evento...</option>';
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                const option = document.createElement("option");
                option.value = doc.id;
                option.text = `${data.nome} (${data.status || 'sem status'})`;
                select.appendChild(option);
            });
        });

        // 2. Monitorar o evento selecionado
        function monitorarEvento() {
            const id = document.getElementById("selectEvento").value;
            if(!id) return;
            eventoAtualID = id;

            db.collection("eventos").doc(id).onSnapshot((doc) => {
                if(doc.exists) {
                    dadosEventoAtual = doc.data();
                    const status = dadosEventoAtual.status || "aberto"; 
                    
                    const display = document.getElementById("displayStatus");
                    display.innerText = status.toUpperCase();

                    if(status === 'aberto') display.style.color = "#00E676";
                    else if(status === 'pausado') display.style.color = "#FFD600";
                    else display.style.color = "#FF1744";
                }
            });
        }

        // 3. Fun√ß√£o para alterar o status no banco
        function mudarStatus(novoStatus) {
            if(!eventoAtualID) return alert("Selecione um evento primeiro!");
            
            if(novoStatus === 'encerrado') {
                if(!confirm("Tem certeza que deseja ENCERRAR o evento? Os convidados n√£o poder√£o mais acessar o card√°pio.")) return;
            }

            db.collection("eventos").doc(eventoAtualID).update({
                status: novoStatus
            }).then(() => {
                // Sucesso
            }).catch((error) => {
                alert("Erro ao atualizar: " + error);
            });
        }

        // 4. Fun√ß√£o do Relat√≥rio (Extrato)
        function abrirRelatorio() {
            if(!eventoAtualID || !dadosEventoAtual) return alert("Selecione um evento primeiro!");
            
            document.getElementById('modalRelatorio').style.display = 'flex';
            
            // Atualiza totais do cabe√ßalho
            document.getElementById('repContratado').innerText = dadosEventoAtual.total_contratado || 0;
            document.getElementById('repConsumido').innerText = dadosEventoAtual.total_consumido || 0;

            const lista = document.getElementById('listaRelatorio');
            lista.innerHTML = '<p style="text-align:center; color:#555;">Carregando...</p>';

            // Busca pedidos do pacote deste evento
            db.collection("pedidos")
              .where("evento_id", "==", eventoAtualID)
              .where("tipo", "==", "pacote") // Apenas itens do pacote
              .get()
              .then(snapshot => {
                  if(snapshot.empty) {
                      lista.innerHTML = '<p style="text-align:center; color:#555; margin-top:20px;">Nenhum consumo registrado no pacote.</p>';
                      return;
                  }

                  let itens = [];
                  snapshot.forEach(doc => itens.push(doc.data()));

                  // Ordena do mais recente para o mais antigo
                  itens.sort((a,b) => {
                      let dA = a.data && a.data.toDate ? a.data.toDate() : new Date();
                      let dB = b.data && b.data.toDate ? b.data.toDate() : new Date();
                      return dB - dA;
                  });

                  lista.innerHTML = '';
                  itens.forEach(item => {
                      // Se foi cancelado, mostra riscado
                      let estiloExtra = "";
                      let statusExtra = "";
                      
                      if(item.status === 'cancelado') {
                          estiloExtra = "text-decoration: line-through; opacity: 0.5;";
                          statusExtra = "(CANCELADO)";
                      }

                      let hora = "??:??";
                      if(item.data && item.data.toDate) {
                          hora = item.data.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                      }

                      lista.innerHTML += `
                        <div class="report-row" style="${estiloExtra}">
                            <span style="width: 50px; color:#888;">${hora}</span>
                            <div style="flex:1; margin-left:10px;">
                                <strong style="color:#fff;">${item.nome_convidado}</strong> ${statusExtra}
                                <br>
                                <span style="color:#2979FF; font-size:0.9em;">${item.drink}</span>
                            </div>
                        </div>
                      `;
                  });
              });
        }
    </script>
</body>
</html>
