<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torre de Controle - Gil Eventos</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #121212; color: #fff; margin: 0; padding: 20px; overflow-x: hidden; }
        
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
        h1 { margin: 0; color: #FFD580; font-size: 1.8em; }
        .badge-event { background: #333; padding: 5px 10px; border-radius: 4px; font-size: 0.8em; margin-left: 10px; vertical-align: middle; }

        .grid-layout { display: grid; grid-template-columns: 300px 1fr 300px; gap: 20px; height: calc(100vh - 100px); }
        .col-commands { display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .card-box { background: #1E1E1E; padding: 20px; border-radius: 12px; border: 1px solid #333; position: relative; }
        .eye-btn { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 1.2em; color: #888; background: none; border: none; }
        .eye-btn:hover { color: #fff; }
        .hidden-value { letter-spacing: 3px; filter: blur(4px); user-select: none; }
        .big-stat { font-size: 2em; font-weight: 800; color: #4CAF50; }
        .label { color: #888; font-size: 0.8em; text-transform: uppercase; margin-bottom: 5px; }
        
        .btn-drink { width: 100%; padding: 12px; background: #333; border: 1px solid #555; color: #fff; margin-bottom: 8px; border-radius: 6px; cursor: pointer; text-align: left; transition: 0.2s; }
        .btn-drink:hover { background: #FFD580; color: #000; border-color: #FFD580; }
        .btn-drink.premium { border-left: 4px solid #FFD580; }

        .col-queue { background: #181818; border-radius: 12px; padding: 15px; border: 1px solid #333; display: flex; flex-direction: column; }
        .queue-header { font-size: 1.2em; font-weight: bold; color: #FFD580; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; }
        .queue-list { overflow-y: auto; flex-grow: 1; padding-right: 5px; }
        
        .order-card { background: #222; border-left: 5px solid #888; border-radius: 8px; padding: 15px; margin-bottom: 15px; animation: slideIn 0.3s; position: relative; }
        .order-card.extra { border-left-color: #FFD580; background: #2A2210; } 
        .order-card.pacote { border-left-color: #4CAF50; } 
        .order-card.pagamento { border-left-color: #FF4444; background: #2a1010; border: 1px dashed #FF4444; }

        .order-info h3 { margin: 5px 0; font-size: 1.3em; }
        .client { color: #aaa; font-size: 0.9em; }
        .time { position: absolute; top: 10px; right: 10px; font-size: 0.8em; color: #666; font-family: monospace; }
        .actions { display: flex; gap: 10px; margin-top: 10px; }
        
        .btn-ok { flex: 2; background: #2E7D32; border: none; padding: 10px; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; }
        .btn-ok:hover { background: #4CAF50; }
        .btn-pay { flex: 2; background: #FFD580; border: none; padding: 10px; border-radius: 5px; color: #000; cursor: pointer; font-weight: bold; }
        .btn-pay:hover { background: #FFAA00; }
        .btn-cancel { flex: 1; background: transparent; border: 1px solid #D32F2F; padding: 10px; border-radius: 5px; color: #D32F2F; cursor: pointer; }
        .btn-cancel:hover { background: #D32F2F; color: white; }

        .col-history { background: #151515; border-radius: 12px; padding: 15px; overflow-y: auto; border: 1px solid #222; }
        .hist-item { padding: 10px; border-bottom: 1px solid #222; font-size: 0.9em; display: flex; justify-content: space-between; }
        .status-done { color: #4CAF50; }
        .status-canceled { color: #D32F2F; text-decoration: line-through; }

        /* MODAIS */
        #loginOverlay, #eyeAuthOverlay, #qrOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #eyeAuthOverlay, #qrOverlay { display: none; }
        .login-box { text-align: center; background: #222; padding: 40px; border-radius: 15px; border: 1px solid #444; }
        .login-input { padding: 15px; font-size: 1.2em; border-radius: 8px; border: 1px solid #333; background: #111; color: #fff; width: 200px; text-align: center; margin-bottom: 15px; display: block; margin-left: auto; margin-right: auto; }
        .btn-login { padding: 15px 30px; background: #FFD580; color: #000; border: none; font-weight: bold; font-size: 1.1em; cursor: pointer; border-radius: 8px; }
        .btn-top { background: #444; color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-left: 10px; transition: 0.3s; }
        
        @media (max-width: 1000px) { .grid-layout { grid-template-columns: 1fr; height: auto; } .col-commands, .col-queue, .col-history { height: 500px; margin-bottom: 20px; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <audio id="somAlerta" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div id="loginOverlay"><div class="login-box"><h1 style="margin-bottom:20px;">üîí √Årea Restrita</h1><input type="password" id="senhaInput" class="login-input" placeholder="Senha"><button class="btn-login" onclick="verificarSenha()">ACESSAR</button><p id="erroSenha" style="color:red; display:none; margin-top:10px;">Senha Incorreta!</p></div></div>
    <div id="eyeAuthOverlay"><div class="login-box"><h3>üëÅÔ∏è Mostrar Dados</h3><input type="password" id="senhaEyeInput" class="login-input" placeholder="Senha"><div style="display:flex; gap:10px; justify-content:center;"><button class="btn-login" onclick="confirmarSenhaEye()">VER</button><button onclick="fecharEyeAuth()" class="btn-top" style="background:transparent; border:1px solid #555;">Cancelar</button></div></div></div>
    <div id="qrOverlay"><div class="login-box"><h2 style="color:#FFD580;">üì≤ Escaneie para Pedir</h2><div id="qrcodeDisplay" style="background:white; padding:15px; border-radius:10px; display:inline-block; margin:20px 0;"></div><div><button onclick="document.getElementById('qrOverlay').style.display='none'" class="btn-login">Fechar</button></div></div></div>

    <div class="header">
        <div><span id="nomeEvento">Carregando...</span><span class="badge-event" id="tipoEvento">...</span></div>
        <div style="text-align: right;"><button onclick="ativarSomManual()" class="btn-top" id="btnSom">üîä Som Ativo</button><button onclick="mostrarQR()" class="btn-top">üì± Ver QR Code</button><button onclick="copiarLink()" class="btn-top">üîó Link</button><button onclick="window.close()" class="btn-top" style="background:transparent; border:1px solid #555; color:#888;">Sair</button></div>
    </div>

    <div class="grid-layout">
        <div class="col-commands">
            <div class="card-box"><div class="label">Consumo Pacote</div><div class="big-stat"><span id="consumido">0</span> <span style="font-size:0.5em; color:#666;">/ <span id="total">‚àû</span></span></div><div id="progressoBg" style="height:5px; background:#333; margin-top:5px; border-radius:3px;"><div id="progressoBar" style="height:100%; width:0%; background:#4CAF50;"></div></div></div>
            <div class="card-box"><button class="eye-btn" onclick="toggleFaturamento()">üëÅÔ∏è</button><div class="label">Faturamento</div><div class="big-stat" style="color:#FFD580;"><span id="valorFaturamento" class="hidden-value">R$ 0,00</span></div><div style="font-size:0.8em; color:#666; margin-top:5px;">Vendas: <span id="qtdVendasExtras">0</span></div></div>
            <div class="card-box"><div class="label">üìù Pedido Manual</div><div id="listaBotoesManual" style="margin-top:10px;"></div></div>
        </div>
        <div class="col-queue"><div class="queue-header"><span>üî• Fila / Caixa</span><span style="font-size:0.8em; background:#FF4444; padding:2px 8px; border-radius:10px; color:white;" id="qtdFila">0</span></div><div class="queue-list" id="listaFila"></div></div>
        <div class="col-history"><div class="queue-header">üìú Hist√≥rico</div><div id="listaHistorico"></div></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDLPi5Mf6_9ypigmf3v9Qe9YYPUr1mfaHk",
            authDomain: "gil-eventos-app-911fe.firebaseapp.com",
            projectId: "gil-eventos-app-911fe",
            storageBucket: "gil-eventos-app-911fe.firebasestorage.app",
            messagingSenderId: "503025880352",
            appId: "1:503025880352:web:694b7f2889cff501c7db45",
            measurementId: "G-3DZ1P5C0M3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const params = new URLSearchParams(window.location.search);
        const EVENTO_ID = params.get('evento');
        let DADOS_EVENTO = null;
        let FATURAMENTO_VISIVEL = false;
        let wakeLock = null;

        if(sessionStorage.getItem(`logado_${EVENTO_ID}`)) document.getElementById('loginOverlay').style.display = 'none';
        if(EVENTO_ID) iniciarTorreControle();

        // MANTEM TELA ACESA (WAKE LOCK)
        async function requestWakeLock() {
            try { wakeLock = await navigator.wakeLock.request('screen'); console.log('Tela Bloqueada Acesa'); } catch (err) { console.log(`${err.name}, ${err.message}`); }
        }
        document.addEventListener('visibilitychange', async () => { if (wakeLock !== null && document.visibilityState === 'visible') requestWakeLock(); });

        function iniciarTorreControle() {
            requestWakeLock(); // Ativa Wake Lock
            db.collection("eventos").doc(EVENTO_ID).onSnapshot((doc) => { if(doc.exists){ DADOS_EVENTO = doc.data(); atualizarInterface(DADOS_EVENTO); gerarBotoes(DADOS_EVENTO.cardapio); } });

            db.collection("pedidos").where("evento_id", "==", EVENTO_ID).where("status", "in", ["pendente", "aguardando_pagamento"])
                .onSnapshot((snapshot) => {
                    const lista = document.getElementById('listaFila');
                    document.getElementById('qtdFila').innerText = snapshot.size;
                    
                    // TOCA O SOM SE TIVER PEDIDO NOVO
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            document.getElementById('somAlerta').play().catch(e => console.log("Interaja com a tela para tocar som"));
                        }
                    });

                    lista.innerHTML = snapshot.empty ? '<div style="text-align:center; color:#555; margin-top:50px;">Nenhum pedido na fila</div>' : '';
                    
                    snapshot.forEach(doc => {
                        const p = doc.data();
                        const hora = p.data.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                        let classe='pacote', badge='üÜì PACOTE', btnHtml=`<button class="btn-ok" onclick="mudarStatus('${doc.id}', 'servido', 'pacote', 0)">‚úÖ PRONTO</button>`;
                        if(p.tipo === 'extra') {
                            if(p.status === 'aguardando_pagamento') { classe='pagamento'; badge=`üî¥ AGUARDANDO PGTO (R$ ${p.preco})`; btnHtml=`<button class="btn-pay" onclick="mudarStatus('${doc.id}', 'servido', 'extra', ${p.preco})">üí∞ CONFIRMAR</button>`; } 
                            else { classe='extra'; badge=`üí≤ PAGO (R$ ${p.preco})`; btnHtml=`<button class="btn-ok" onclick="mudarStatus('${doc.id}', 'servido', 'extra', ${p.preco})">‚úÖ PRONTO</button>`; }
                        }
                        lista.innerHTML += `<div class="order-card ${classe}"><div class="time">${hora}</div><div class="client">${p.nome_convidado}</div><div class="order-info"><h3>${p.drink}</h3><small style="background:rgba(0,0,0,0.3); padding:2px 5px; border-radius:3px;">${badge}</small></div><div class="actions"><button class="btn-cancel" onclick="mudarStatus('${doc.id}', 'cancelado')">‚úñ</button>${btnHtml}</div></div>`;
                    });
                });

            db.collection("pedidos").where("evento_id", "==", EVENTO_ID).where("status", "in", ["servido", "cancelado"]).limit(30)
                .onSnapshot((s) => { const l = document.getElementById('listaHistorico'); l.innerHTML = ''; s.forEach(doc => { const p = doc.data(); let st = p.status === 'servido' ? '<span class="status-done">‚úî Entregue</span>' : '<span class="status-canceled">‚úñ Cancelado</span>'; l.innerHTML += `<div class="hist-item"><div><strong style="color:#FFD580">${p.drink}</strong><br><span style="color:#666">${p.nome_convidado}</span></div><div style="text-align:right">${st}</div></div>`; }); });
        }

        function verificarSenha() { 
            if(document.getElementById('senhaInput').value === DADOS_EVENTO.senha_admin) { 
                document.getElementById('loginOverlay').style.display = 'none'; 
                sessionStorage.setItem(`logado_${EVENTO_ID}`, true);
                // Tenta tocar som silenciado s√≥ pra liberar o audio do navegador
                document.getElementById('somAlerta').play().catch(() => {});
            } else document.getElementById('erroSenha').style.display='block'; 
        }
        
        function ativarSomManual() { document.getElementById('somAlerta').play(); } // Bot√£o de teste
        function toggleFaturamento() { const el=document.getElementById('valorFaturamento'); if(FATURAMENTO_VISIVEL){el.classList.add('hidden-value');FATURAMENTO_VISIVEL=false;}else{document.getElementById('eyeAuthOverlay').style.display='flex';document.getElementById('senhaEyeInput').focus();} }
        function confirmarSenhaEye() { if(document.getElementById('senhaEyeInput').value===DADOS_EVENTO.senha_admin){document.getElementById('eyeAuthOverlay').style.display='none';document.getElementById('valorFaturamento').classList.remove('hidden-value');FATURAMENTO_VISIVEL=true;}else alert("Senha errada"); }
        function fecharEyeAuth() { document.getElementById('eyeAuthOverlay').style.display = 'none'; }
        function mostrarQR() { const url=window.location.href.replace('dashboard.html','index.html'); document.getElementById('qrcodeDisplay').innerHTML=''; new QRCode(document.getElementById("qrcodeDisplay"),{text:url,width:250,height:250}); document.getElementById('qrOverlay').style.display='flex'; }
        function copiarLink() { navigator.clipboard.writeText(window.location.href.replace('dashboard.html','index.html')); alert("Copiado!"); }
        function atualizarInterface(dados) { document.getElementById('nomeEvento').innerText = dados.nome; document.getElementById('consumido').innerText = dados.total_consumido; if(dados.tipo_servico === 'pacote') { document.getElementById('total').innerText = dados.total_contratado; document.getElementById('progressoBar').style.width = ((dados.total_consumido/dados.total_contratado)*100)+'%'; } document.getElementById('valorFaturamento').innerText = `R$ ${dados.total_faturamento.toFixed(2)}`; document.getElementById('qtdVendasExtras').innerText = dados.total_vendas_extra; }
        function gerarBotoes(menu) { const div = document.getElementById('listaBotoesManual'); div.innerHTML = ''; menu.forEach(item => { const btn = document.createElement('button'); btn.className = item.is_premium ? 'btn-drink premium' : 'btn-drink'; btn.innerText = (item.is_premium?'üí≤ ':'üÜì ') + item.nome; btn.onclick = () => lancarManual(item); div.appendChild(btn); }); }
        function lancarManual(item) { if(!confirm(`Lan√ßar ${item.nome}?`)) return; let tipo = 'pacote'; if(item.is_premium || (DADOS_EVENTO.tipo_servico==='pacote' && DADOS_EVENTO.total_consumido >= DADOS_EVENTO.total_contratado)) tipo='extra'; db.collection("pedidos").add({ evento_id: EVENTO_ID, drink: item.nome, tipo: tipo, preco: item.preco||0, nome_convidado: "Balc√£o", status: 'pendente', data: new Date() }); }
        function mudarStatus(id, novoStatus, tipo, preco) { db.collection("pedidos").doc(id).update({ status: novoStatus }); if(novoStatus === 'servido') { if(tipo === 'pacote') db.collection("eventos").doc(EVENTO_ID).update({ total_consumido: firebase.firestore.FieldValue.increment(1) }); if(tipo === 'extra') db.collection("eventos").doc(EVENTO_ID).update({ total_vendas_extra: firebase.firestore.FieldValue.increment(1), total_faturamento: firebase.firestore.FieldValue.increment(preco) }); } }
    </script>
</body>
</html>
