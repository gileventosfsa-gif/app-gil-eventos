<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central de Comando - Gil Eventos</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #121212; color: #EAEAEA; margin: 0; padding: 20px; }
        
        /* HEADER E NAV */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .logo { font-size: 1.5em; font-weight: 800; color: #FFD580; text-transform: uppercase; letter-spacing: 2px; }
        .nav-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .btn-nav { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; color: #fff; font-size: 0.9em; transition: transform 0.2s; }
        .btn-nav:hover { transform: translateY(-2px); }
        .btn-novo { background: #00E676; color: #000; }
        .btn-agenda { background: #9C27B0; }
        .btn-site { background: #FFD580; color: #000; }
        .btn-reviews { background: #2196F3; }

        /* BARRA DE PESQUISA */
        .search-container { margin-bottom: 30px; position: relative; }
        .search-input { width: 100%; padding: 15px; background: #1E1E1E; border: 1px solid #333; color: #fff; border-radius: 10px; font-size: 1.1em; outline: none; }
        .search-input:focus { border-color: #FFD580; }

        /* LISTA DE EVENTOS */
        .events-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        
        .event-card { background: #1E1E1E; border: 1px solid #333; border-radius: 12px; padding: 20px; position: relative; transition: all 0.3s; }
        .event-card:hover { border-color: #FFD580; transform: translateY(-3px); }
        
        /* STATUS INDICATOR */
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-aberto { background: #00E676; box-shadow: 0 0 8px #00E676; }
        .status-pausado { background: #FFD600; }
        .status-encerrado { background: #FF1744; }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .event-title { font-size: 1.2em; font-weight: 700; color: #fff; margin: 0; }
        .event-date { font-size: 0.85em; color: #aaa; display: block; margin-top: 5px; }
        .event-type { background: #333; font-size: 0.7em; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; color: #ccc; }

        /* CARD STATS */
        .card-stats { display: flex; gap: 15px; margin-bottom: 15px; font-size: 0.85em; color: #888; border-top: 1px solid #333; padding: 10px 0; }
        .stat-item strong { color: #FFD580; }

        /* ACTIONS */
        .card-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .btn-card { padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: 0.2s; }
        .btn-torre { background: #2196F3; color: white; grid-column: 1 / -1; } 
        .btn-edit { background: #444; color: #ccc; }
        .btn-copy { background: #444; color: #ccc; }
        .btn-delete { background: transparent; border: 1px solid #FF1744; color: #FF1744; margin-top: 10px; width: 100%; font-size: 0.8em; }

        /* CONTROLES R√ÅPIDOS NO CARD */
        .quick-controls { background: #252525; padding: 10px; border-radius: 8px; display: flex; gap: 5px; align-items: center; justify-content: space-between; border: 1px solid #333; }
        .btn-mini-ctrl { width: 35px; height: 35px; border-radius: 5px; border: none; cursor: pointer; font-size: 1.2em; display: flex; align-items: center; justify-content: center; transition: 0.2s; background: #333; }
        .btn-mini-ctrl:hover { transform: scale(1.1); }
        .btn-mini-ctrl.abrir:hover { background: #00E676; }
        .btn-mini-ctrl.pausar:hover { background: #FFD600; }
        .btn-mini-ctrl.fechar:hover { background: #FF1744; }
        
        .btn-extrato { flex-grow: 1; background: #2962FF; color: white; border: none; border-radius: 5px; height: 35px; font-weight: bold; cursor: pointer; font-size: 0.8em; margin-left: 5px; }
        .btn-extrato:hover { background: #1565C0; }

        /* MODAL GERAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { text-align: center; width: 90%; max-width: 300px; background: #222; padding: 30px; border-radius: 15px; border: 1px solid #444; }
        .modal-box-large { background: #1E1E1E; padding: 25px; border-radius: 15px; width: 90%; max-width: 700px; height: 85vh; display: flex; flex-direction: column; border: 1px solid #333; }

        /* ESTILOS DO RELAT√ìRIO (MODAL) */
        .modal-report-box { background: #1E1E1E; padding: 20px; border-radius: 15px; width: 90%; max-width: 500px; height: 85vh; display: flex; flex-direction: column; border: 1px solid #444; }
        
        .report-summary { background: #222; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 1px solid #444; }
        .report-list { flex-grow: 1; overflow-y: auto; background: #121212; padding: 10px; border-radius: 8px; border: 1px solid #333; text-align: left; }
        .report-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 8px 0; font-size: 0.85em; color: #ccc; }
        .report-header { font-weight: bold; color: #FFD580; margin-bottom: 10px; border-bottom: 2px solid #FFD580; padding-bottom: 5px; display: flex; justify-content: space-between; }

        /* TABS AVALIA√á√ïES */
        .tabs-header { display: flex; border-bottom: 1px solid #333; margin-bottom: 15px; }
        .tab-link { flex: 1; padding: 15px; background: none; border: none; color: #777; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-link.active { color: #FFD580; border-bottom-color: #FFD580; }
        .review-list-global { flex: 1; overflow-y: auto; text-align: left; }
        
        .review-item-global { background: #222; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid #555; }
        .review-item-global.pendente { border-left-color: #FFD580; background: rgba(255, 213, 128, 0.05); }
        .review-item-global.aprovado { border-left-color: #4CAF50; }
        
        .review-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9em; }
        .event-tag { background: #333; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; text-transform: uppercase; color: #aaa; margin-left: 10px; }
        
        .review-actions { display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end; }
        .btn-mini { padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.8em; color: white; }
        .btn-mini.approve { background: #4CAF50; }
        .btn-mini.delete { background: #FF1744; }

        /* RESPONSIVO */
        @media (max-width: 600px) {
            .header { flex-direction: column; align-items: flex-start; }
            .nav-buttons { width: 100%; justify-content: space-between; }
            .btn-nav { flex: 1; justify-content: center; }
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h1 class="logo">CENTRAL GIL</h1>
            <p style="color:#aaa;">Digite sua senha mestra</p>
            <input type="password" id="senhaMestra" style="width:100%; padding:15px; border-radius:8px; border:none; margin-bottom:15px; text-align:center;" placeholder="Senha">
            <button onclick="fazerLogin()" style="width:100%; padding:15px; background:#FFD580; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">ENTRAR</button>
        </div>
    </div>

    <div id="modalRelatorio" class="modal-overlay">
        <div class="modal-report-box">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="color:#2979FF; margin:0;">Extrato do Pacote</h2>
                <button onclick="document.getElementById('modalRelatorio').style.display='none'" style="background:none; border:none; color:#fff; font-size:1.5em; cursor:pointer;">&times;</button>
            </div>
            <p style="color:#aaa; font-size:0.8em; margin-bottom:15px;">Visualiza√ß√£o r√°pida. Clique em baixar para gerar o PDF.</p>
            
            <div id="areaDadosEvento">
                <div style="text-align:center; margin-bottom:10px; border-bottom:1px solid #444; padding-bottom:5px;">
                    <strong style="color:#FFD580; text-transform: uppercase;" id="nomeEventoRelatorio">...</strong><br>
                    <small style="color:#aaa;" id="dataEventoRelatorio">...</small>
                </div>

                <div class="report-summary">
                    <div style="display:flex; justify-content:space-around;">
                        <div>
                            <small style="color:#888;">CONTRATADO</small><br>
                            <strong style="font-size:1.4em; color:#fff;" id="repContratado">0</strong>
                        </div>
                        <div style="border-right:1px solid #444;"></div>
                        <div>
                            <small style="color:#888;">CONSUMIDO</small><br>
                            <strong style="font-size:1.4em; color:#00E676;" id="repConsumido">0</strong>
                        </div>
                    </div>
                </div>
            </div>

            <div class="report-header">
                <span style="width: 50px;">HORA</span>
                <span style="flex: 1; margin-left: 10px;">CLIENTE / DRINK</span>
            </div>
            
            <div id="listaRelatorio" class="report-list">
                <p style="text-align:center; color:#555;">Carregando...</p>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="baixarPDFExtrato()" style="flex:1; background:#E53935; color:#fff; border:none; padding:15px; border-radius:8px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:5px;">
                    üìÑ BAIXAR PDF
                </button>
                <button onclick="document.getElementById('modalRelatorio').style.display='none'" style="background:#333; color:white; border:1px solid #555; padding:15px; border-radius:8px; cursor:pointer;">Fechar</button>
            </div>
        </div>
    </div>

    <div id="modalAvaliacoes" class="modal-overlay">
        <div class="modal-box-large">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="margin:0; color:#FFD580;">‚≠ê Gest√£o Global de Avalia√ß√µes</h2>
                <button onclick="document.getElementById('modalAvaliacoes').style.display='none'" style="background:none; border:none; color:#fff; font-size:1.5em; cursor:pointer;">&times;</button>
            </div>
            
            <div class="tabs-header">
                <button class="tab-link active" onclick="mudarAbaReviews('pendente')">‚è≥ Pendentes (Moderar)</button>
                <button class="tab-link" onclick="mudarAbaReviews('aprovado')">‚úÖ Aprovadas (Hist√≥rico)</button>
            </div>

            <div id="listaReviewsGlobal" class="review-list-global">
                <p style="text-align:center; color:#666; margin-top:20px;">Carregando...</p>
            </div>
        </div>
    </div>

    <div class="header">
        <div class="logo">ü¶Ö CENTRAL DE COMANDO</div>
        <div class="nav-buttons">
¬† ¬† ¬† ¬† ¬† ¬† <a href="admin.html" class="btn-nav btn-novo" target="_blank">‚ûï Novo Evento</a>
            <button onclick="abrirQRGlobal()" class="btn-nav" style="background:#FF9500; color:#000;">üì± QR Code Fixo</button>
¬† ¬† ¬† ¬† ¬† ¬† <button onclick="abrirCentralAvaliacoes()" class="btn-nav btn-reviews">‚≠ê Avalia√ß√µes</button>
            <a href="agenda.html" class="btn-nav btn-agenda" target="_blank">üìÖ Agenda</a>
            <a href="index.html" class="btn-nav btn-site" target="_blank">üí∞ Simulador</a>
        </div>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç Buscar evento por nome, data ou tipo..." onkeyup="filtrarEventos()">
    </div>

    <h3 style="color:#aaa; margin-top:0;">SEUS EVENTOS (<span id="totalEventos">0</span>)</h3>
    <div id="gridEventos" class="events-grid">
        <p style="color:#666;">Carregando eventos...</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyDLPi5Mf6_9ypigmf3v9Qe9YYPUr1mfaHk", authDomain: "gil-eventos-app-911fe.firebaseapp.com", projectId: "gil-eventos-app-911fe", storageBucket: "gil-eventos-app-911fe.firebasestorage.app", messagingSenderId: "503025880352", appId: "1:503025880352:web:694b7f2889cff501c7db45", measurementId: "G-3DZ1P5C0M3" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- SENHA MESTRA ---
        const SENHA_DEFINIDA = "9859"; 

        function fazerLogin() {
            const s = document.getElementById('senhaMestra').value;
            if(s === SENHA_DEFINIDA) {
                document.getElementById('loginOverlay').style.display = 'none';
                sessionStorage.setItem('central_gil_logado', 'true');
                carregarEventos();
            } else {
                alert("Senha Incorreta!");
            }
        }

        if(sessionStorage.getItem('central_gil_logado')) {
            document.getElementById('loginOverlay').style.display = 'none';
            carregarEventos();
        }

        let listaEventosCache = [];
        // Vari√°veis globais para armazenar dados do relat√≥rio atual
        let RELATORIO_ATUAL_DADOS = [];
        let RELATORIO_ATUAL_EVENTO = null;

        function carregarEventos() {
            db.collection("eventos").orderBy("data_criacao", "desc").onSnapshot(snapshot => {
                const grid = document.getElementById('gridEventos');
                grid.innerHTML = "";
                listaEventosCache = [];

                if(snapshot.empty) {
                    grid.innerHTML = "<p>Nenhum evento encontrado.</p>";
                    return;
                }

                document.getElementById('totalEventos').innerText = snapshot.size;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    const evento = { id, ...data };
                    listaEventosCache.push(evento);
                    grid.innerHTML += criarCardEvento(evento);
                });
            });
        }

        function criarCardEvento(e) {
            let statusClass = 'status-aberto';
            let statusText = 'Aberto';
            if(e.status === 'pausado') { statusClass = 'status-pausado'; statusText = 'Pausado'; }
            if(e.status === 'encerrado') { statusClass = 'status-encerrado'; statusText = 'Encerrado'; }

            let dataFormatada = "Data n√£o def.";
            if(e.data_evento) {
                try {
                    const partes = e.data_evento.split('-');
                    if(partes.length === 3) dataFormatada = `${partes[2]}/${partes[1]}/${partes[0]}`;
                    else dataFormatada = e.data_evento;
                } catch(err) { dataFormatada = e.data_evento }
            }

            return `
            <div class="event-card">
                <div class="card-header">
                    <div>
                        <div style="display:flex; align-items:center; margin-bottom:5px;">
                            <span class="status-dot ${statusClass}"></span>
                            <span style="font-size:0.8em; color:#aaa; text-transform:uppercase;">${statusText}</span>
                        </div>
                        <h3 class="event-title">${e.nome}</h3>
                        <span class="event-date">üìÖ ${dataFormatada}</span>
                    </div>
                    <span class="event-type">${e.tipo_servico || 'Padr√£o'}</span>
                </div>

                <div class="card-stats">
                    <span class="stat-item">Consumo: <strong>${e.total_consumido || 0}</strong></span>
                    <span class="stat-item">Faturamento: <strong>R$ ${(e.total_faturamento || 0).toFixed(2)}</strong></span>
                </div>

                <div class="card-actions">
                    <button class="btn-card btn-torre" onclick="window.open('dashboard.html?evento=${e.id}', '_blank')">üöÄ TORRE DE CONTROLE</button>
                    <button class="btn-card btn-edit" onclick="window.open('admin.html?evento=${e.id}', '_blank')">‚úèÔ∏è Editar</button>
                    <button class="btn-card btn-copy" onclick="copiarLinkEvento('${e.id}')">üîó Link Card√°pio</button>
                </div>
                
                <div class="quick-controls">
                    <button class="btn-mini-ctrl abrir" onclick="mudarStatus('${e.id}', 'aberto')" title="Abrir Bar">üü¢</button>
                    <button class="btn-mini-ctrl pausar" onclick="mudarStatus('${e.id}', 'pausado')" title="Pausar Pedidos">‚úã</button>
                    <button class="btn-mini-ctrl fechar" onclick="mudarStatus('${e.id}', 'encerrado')" title="Encerrar Evento">üèÅ</button>
                    <button class="btn-extrato" onclick="abrirRelatorioCard('${e.id}')">üìä EXTRATO PACOTE</button>
                </div>
                
                <button class="btn-card btn-delete" onclick="excluirEvento('${e.id}', '${e.nome}')">üóëÔ∏è Excluir Evento</button>
            </div>
            `;
        }

        function mudarStatus(id, novoStatus) {
            if(novoStatus === 'encerrado' && !confirm("Tem certeza que deseja ENCERRAR este evento?")) return;
            db.collection("eventos").doc(id).update({ status: novoStatus })
            .then(() => {}).catch(err => alert("Erro: " + err));
        }

        function abrirRelatorioCard(id) {
            document.getElementById('modalRelatorio').style.display = 'flex';
            
            // Pega dados do evento do cache local
            const evento = listaEventosCache.find(e => e.id === id);
            RELATORIO_ATUAL_EVENTO = evento; // Salva para o PDF usar depois
            
            document.getElementById('repContratado').innerText = evento.total_contratado || 0;
            document.getElementById('repConsumido').innerText = evento.total_consumido || 0;
            document.getElementById('nomeEventoRelatorio').innerText = evento.nome;
            document.getElementById('dataEventoRelatorio').innerText = evento.data_evento || "Data n/d";

            const lista = document.getElementById('listaRelatorio');
            lista.innerHTML = '<p style="text-align:center; color:#555;">Carregando...</p>';

            // Busca pedidos
            db.collection("pedidos")
              .where("evento_id", "==", id)
              .where("tipo", "==", "pacote")
              .get()
              .then(snapshot => {
                  if(snapshot.empty) {
                      lista.innerHTML = '<p style="text-align:center; color:#555; margin-top:20px;">Nenhum consumo registrado.</p>';
                      RELATORIO_ATUAL_DADOS = [];
                      return;
                  }

                  let itens = [];
                  snapshot.forEach(doc => itens.push(doc.data()));
                  itens.sort((a,b) => {
                      let dA = a.data && a.data.toDate ? a.data.toDate() : new Date();
                      let dB = b.data && b.data.toDate ? b.data.toDate() : new Date();
                      return dB - dA;
                  });

                  RELATORIO_ATUAL_DADOS = itens; // Salva para o PDF

                  lista.innerHTML = '';
                  itens.forEach(item => {
                      let estiloExtra = "";
                      let statusExtra = "";
                      if(item.status === 'cancelado') {
                          estiloExtra = "text-decoration: line-through; opacity: 0.5;";
                          statusExtra = "(CANC)";
                      }
                      let hora = "??:??";
                      if(item.data && item.data.toDate) {
                          hora = item.data.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                      }

                      lista.innerHTML += `
                        <div class="report-row" style="${estiloExtra}">
                            <span style="width: 50px; color:#888;">${hora}</span>
                            <div style="flex:1; margin-left:10px;">
                                <strong style="color:#fff;">${item.nome_convidado}</strong> ${statusExtra}
                                <br>
                                <span style="color:#2979FF; font-size:0.9em;">${item.drink}</span>
                            </div>
                        </div>
                      `;
                  });
              });
        }

        // --- FUN√á√ÉO DE DOWNLOAD EM PDF (NOVA) ---
        function baixarPDFExtrato() {
            if(!RELATORIO_ATUAL_EVENTO || RELATORIO_ATUAL_DADOS.length === 0) {
                return alert("N√£o h√° dados para gerar o PDF.");
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Configura√ß√£o do PDF
            const nomeEvento = RELATORIO_ATUAL_EVENTO.nome.toUpperCase();
            const dataEvento = RELATORIO_ATUAL_EVENTO.data_evento || "Data n/d";
            const dataEmissao = new Date().toLocaleString('pt-BR');

            // Cabe√ßalho
            doc.setFontSize(18);
            doc.text("GIL EVENTOS - EXTRATO PACOTE", 105, 15, null, null, "center");
            
            doc.setFontSize(12);
            doc.text(`Evento: ${nomeEvento}`, 14, 25);
            doc.text(`Data do Evento: ${dataEvento}`, 14, 32);
            doc.text(`Emiss√£o: ${dataEmissao}`, 14, 39);

            // Resumo
            doc.setDrawColor(0);
            doc.setFillColor(240, 240, 240);
            doc.rect(14, 45, 182, 20, 'F');
            
            doc.setFontSize(10);
            doc.text("TOTAL CONTRATADO", 40, 50, null, null, "center");
            doc.text("TOTAL CONSUMIDO", 160, 50, null, null, "center");
            
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text(String(RELATORIO_ATUAL_EVENTO.total_contratado || 0), 40, 60, null, null, "center");
            
            // Cor condicional para o consumido
            const consumido = RELATORIO_ATUAL_EVENTO.total_consumido || 0;
            const contratado = RELATORIO_ATUAL_EVENTO.total_contratado || 0;
            if(consumido > contratado) doc.setTextColor(255, 0, 0); // Vermelho se passar
            else doc.setTextColor(0, 128, 0); // Verde se ok
            
            doc.text(String(consumido), 160, 60, null, null, "center");
            doc.setTextColor(0, 0, 0); // Reset cor

            // Tabela de Itens (Reverte ordem para cronol√≥gica no PDF: mais antigo primeiro)
            const dadosTabela = [...RELATORIO_ATUAL_DADOS].reverse().map(item => {
                let hora = "--:--";
                if(item.data && item.data.toDate) {
                    hora = item.data.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
                
                let status = item.status === 'cancelado' ? '(CANCELADO)' : '';
                
                // Formata array para o autotable
                return [hora, item.nome_convidado, item.drink, status];
            });

            doc.autoTable({
                startY: 70,
                head: [['HORA', 'QUEM PEDIU', 'DRINK', 'STATUS']],
                body: dadosTabela,
                theme: 'striped',
                headStyles: { fillColor: [41, 98, 255] }, // Azul
                styles: { fontSize: 9 },
                didParseCell: function(data) {
                    // Risca itens cancelados
                    if (data.row.raw[3] === '(CANCELADO)') {
                        data.cell.styles.textColor = [150, 150, 150];
                        data.cell.styles.fontStyle = 'italic';
                    }
                }
            });

            // Rodap√©
            const paginas = doc.internal.getNumberOfPages();
            for(let i = 1; i <= paginas; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text('Sistema Gil Eventos - Controle Digital', 105, 290, null, null, 'center');
            }

            // Salva o arquivo com nome limpo
            const nomeArquivo = `Extrato_${nomeEvento.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`;
            doc.save(nomeArquivo);
        }

        function filtrarEventos() {
            const termo = document.getElementById('searchInput').value.toLowerCase();
            const grid = document.getElementById('gridEventos');
            grid.innerHTML = "";

            const filtrados = listaEventosCache.filter(e => {
                return (e.nome && e.nome.toLowerCase().includes(termo)) || 
                       (e.data_evento && e.data_evento.includes(termo)) ||
                       (e.tipo_servico && e.tipo_servico.toLowerCase().includes(termo));
            });

            if(filtrados.length === 0) {
                grid.innerHTML = "<p>Nenhum evento encontrado com esse nome.</p>";
            } else {
                filtrados.forEach(e => {
                    grid.innerHTML += criarCardEvento(e);
                });
            }
        }

        function copiarLinkEvento(id) {
            const urlBase = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
            const link = `${urlBase}/cardapio.html?evento=${id}`;
            navigator.clipboard.writeText(link).then(() => alert("‚úÖ Link do CARD√ÅPIO copiado!"));
        }

        function excluirEvento(id, nome) {
            if(confirm(`‚ö†Ô∏è PERIGO!\n\nTem certeza que deseja apagar o evento "${nome}"?\n\nIsso apagar√° todos os pedidos e dados dele. N√£o tem volta.`)) {
                const senha = prompt("Digite a senha mestra para confirmar a exclus√£o:");
                if(senha === SENHA_DEFINIDA) {
                    db.collection("eventos").doc(id).delete()
                    .then(() => alert("Evento exclu√≠do com sucesso."))
                    .catch(err => alert("Erro: " + err));
                } else {
                    alert("Senha incorreta. Exclus√£o cancelada.");
                }
            }
        }

        // --- GEST√ÉO GLOBAL DE AVALIA√á√ïES ---
        let abaAtualReviews = 'pendente';

        function abrirCentralAvaliacoes() {
            document.getElementById('modalAvaliacoes').style.display = 'flex';
            mudarAbaReviews('pendente');
        }

        function mudarAbaReviews(aba) {
            abaAtualReviews = aba;
            document.querySelectorAll('.tab-link').forEach(btn => btn.classList.remove('active'));
            const btns = document.querySelectorAll('.tab-link');
            if(aba === 'pendente') btns[0].classList.add('active');
            else btns[1].classList.add('active');

            carregarAvaliacoesGlobal();
        }

        function carregarAvaliacoesGlobal() {
            const lista = document.getElementById('listaReviewsGlobal');
            lista.innerHTML = '<p style="text-align:center; color:#666; margin-top:20px;">Carregando...</p>';

            db.collection("avaliacoes").where("status", "==", abaAtualReviews).get().then(snapshot => {
                if(snapshot.empty) {
                    lista.innerHTML = '<p style="text-align:center; color:#666; margin-top:20px;">Nenhuma avalia√ß√£o encontrada nesta aba.</p>';
                    return;
                }

                let reviews = [];
                snapshot.forEach(doc => reviews.push({ id: doc.id, ...doc.data() }));
                reviews.sort((a,b) => b.data_evento.toDate() - a.data_evento.toDate());

                lista.innerHTML = "";
                reviews.forEach(r => {
                    const dataStr = r.data_evento.toDate().toLocaleDateString();
                    const estrelas = "‚≠ê".repeat(r.nota);
                    
                    let botoesHtml = "";
                    if(abaAtualReviews === 'pendente') {
                        botoesHtml = `
                            <button class="btn-mini approve" onclick="moderarGlobal('${r.id}', true)">‚úÖ Aprovar</button>
                            <button class="btn-mini delete" onclick="moderarGlobal('${r.id}', false)">üóëÔ∏è Excluir</button>
                        `;
                    } else {
                        botoesHtml = `
                            <button class="btn-mini delete" onclick="moderarGlobal('${r.id}', false)">üóëÔ∏è Excluir do Mural</button>
                        `;
                    }

                    lista.innerHTML += `
                        <div class="review-item-global ${abaAtualReviews}">
                            <div class="review-header">
                                <div>
                                    <strong style="color:#fff;">${r.cliente}</strong>
                                    <span class="event-tag">${r.nome_evento || 'Evento'}</span>
                                </div>
                                <span style="color:#FFD580;">${estrelas}</span>
                            </div>
                            <div style="font-size:0.85em; color:#aaa; margin-bottom:5px;">${r.drink} ‚Ä¢ ${dataStr}</div>
                            <div style="font-style:italic; color:#ddd;">"${r.comentario}"</div>
                            <div class="review-actions">
                                ${botoesHtml}
                            </div>
                        </div>
                    `;
                });
            });
        }

       function moderarGlobal(id, aprovar) {
¬† ¬† ¬† ¬† ¬† ¬† if(aprovar) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† db.collection("avaliacoes").doc(id).update({ status: 'aprovado' })
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† .then(() => carregarAvaliacoesGlobal());
¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if(confirm("Tem certeza que deseja EXCLUIR esta avalia√ß√£o?")) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† db.collection("avaliacoes").doc(id).delete()
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† .then(() => carregarAvaliacoesGlobal());
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† }

        function abrirQRGlobal() {
            const urlBase = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
            const linkAcesso = `${urlBase}/acesso.html`;
            
            const msg = `Seu QR CODE FIXO para o balc√£o deve apontar para:\n\n${linkAcesso}\n\nDeseja copiar este link agora?`;
            
            if(confirm(msg)) {
                navigator.clipboard.writeText(linkAcesso).then(() => {
                    alert("‚úÖ Link copiado! Use este link para gerar sua placa de QR Code permanente.");
                });
            }
        }

    </script>
</body>
</html>
